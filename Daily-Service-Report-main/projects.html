<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Project Lists - Daily Service Reports</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    * { font-family: Helvetica, Arial, sans-serif; }
    html, body { height: 100%; min-height: 100vh; overflow-x: auto; }
    body { font-family: Helvetica, Arial, sans-serif; margin: 0; padding: 0; padding-bottom: 0 !important; background: #f6f7fb; color: #0f172a; display: flex; flex-direction: column; min-height: 100vh; }
    input, select, button, textarea, table, th, td { font-family: Helvetica, Arial, sans-serif; }
    .brand-header { 
      background: #0e1111; 
      color: #fff; 
      padding: 20px 24px; 
      text-align: left; 
      margin: 0; 
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    .brand-header h1 { 
      margin: 0; 
      font-size: 28px; 
      font-weight: 700; 
      letter-spacing: 1px; 
      font-family: Helvetica, Arial, sans-serif; 
    }
    .brand-header button { padding: 5px 10px; font-size: 12px; border-radius: 6px; min-width: 60px; }
    .container { 
      max-width: 100%; 
      margin: 24px 0 0 0; 
      background: transparent; 
      padding: 20px 12px 0 12px; 
      border-radius: 0; 
      box-shadow: none; 
      width: 100%; 
      flex: 1 1 auto;
      box-sizing: border-box; 
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }
    #list {
      margin: 0;
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
      width: 100%;
      height: 100%;
    }
    .topbar { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .muted { color: #64748b; }
    input, button { padding: 6px 10px; border: 2px solid #64748b; border-radius: 6px; font-size: 13px; }
    button { appearance: none; border: 0; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; }
    button.secondary { background: #e2e8f0; color: #0f172a; }
    /* Table styling matching admin dashboard with frosted glass effect */
    .table-wrapper {
      display: flex;
      flex-direction: column;
      width: 100%;
      align-items: center;
      flex: 1;
      overflow: hidden;
      min-height: 0;
      position: relative;
    }
    .project-controls {
      margin-bottom: 8px !important;
      margin-top: 0 !important;
      padding-bottom: 0 !important;
      padding-top: 0 !important;
      flex-shrink: 0;
      justify-content: flex-start;
      width: 650px;
      max-width: 650px;
      display: flex;
      gap: 12px;
      align-items: center;
      padding-left: 2px;
      box-sizing: border-box;
    }
    .table-center { 
      display: flex;
      justify-content: center;
      width: 100%;
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
      margin: 0;
      padding: 0;
      min-height: 0;
    }
    table {
      width: 100%;
      max-width: 650px;
      margin: 0 auto;
      border-collapse: collapse;
      border: 2px solid #cbd5e1;
      border-top: 3px solid #2563eb;
      border-radius: 10px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(24px) saturate(180%);
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      box-shadow: 0 15px 50px rgba(2, 6, 23, 0.2);
      table-layout: fixed;
    }
    th, td {
      font-size: 11px;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      text-align: left;
      vertical-align: middle;
      background: rgba(255, 255, 255, 0.4);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th {
      background: #0e1111;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      font-size: 9px;
      letter-spacing: 0.4px;
      position: sticky;
      top: 0;
      z-index: 1;
      padding: 6px 8px;
    }
    
    /* Column width optimization - compact table (650px total width) */
    th:nth-child(1), td:nth-child(1) { /* Project Code */
      width: 120px;
      white-space: normal;
      word-wrap: break-word;
    }
    th:nth-child(2), td:nth-child(2) { /* PO/Start Date */
      width: 90px;
    }
    th:nth-child(3), td:nth-child(3) { /* Client */
      width: 90px;
    }
    th:nth-child(4), td:nth-child(4) { /* Project Name */
      width: 140px;
    }
    th:nth-child(5), td:nth-child(5) { /* Industry */
      width: 80px;
    }
    th:nth-child(6), td:nth-child(6) { /* Location */
      width: 90px;
    }
    th:nth-child(7), td:nth-child(7) { /* PIC */
      width: 60px;
    }
    th:nth-child(8), td:nth-child(8) { /* Action */
      width: 100px;
      padding: 4px 6px !important;
      text-align: center;
    }
    /* Action buttons - compact styling */
    td:nth-child(8) button {
      padding: 3px 6px;
      font-size: 9px;
      border-radius: 3px;
      margin: 0;
    }
    td:nth-child(8) button:first-child {
      margin-right: 3px;
    }
    thead th { 
      position: sticky; 
      top: 0; 
      z-index: 1;
      background: #0e1111;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #cbd5e1;
    }
    thead th:first-child, tbody td:first-child { border-left: 1px solid #cbd5e1; }
    thead th:last-child, tbody td:last-child { border-right: 1px solid #cbd5e1; }
    tbody tr { transition: background-color 0.2s ease; }
    tbody tr:nth-child(odd) { background: rgba(248, 250, 252, 0.4); }
    tbody tr:nth-child(even) { background: rgba(255, 255, 255, 0.2); }
    tbody tr:hover { background-color: rgba(238, 242, 255, 0.5); }
    .actions-cell { white-space: nowrap; }
    .actions-cell button {
      margin-right: 6px;
      background: #e2e8f0;
      color: #0f172a;
      border: 0;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
    }
    .actions-cell button:hover { background: #cbd5e1; }
    .badge { display: inline-block; background: #eef2ff; color: #3730a3; border: 1px solid #c7d2fe; border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    /* Modal styles */
    .modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-overlay.show { display: flex; }
    .modal-dialog { background: #fff; width: 95%; max-width: 600px; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(14,17,17,.15); }
    .modal-header { text-align: center; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; font-size: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
    .form-group input { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid #0e1111; border-radius: 8px; font-size: 14px; }
    .form-group input:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }
    .modal-actions { display: flex; gap: 12px; justify-content: center; margin-top: 24px; }
    .save-btn { background: #e2e8f0; color: #0f172a; padding: 10px 32px; border-radius: 24px; border: 0; font-weight: 700; cursor: pointer; font-size: 14px; }
    .cancel-btn { background: #e2e8f0; color: #0f172a; padding: 10px 32px; border-radius: 24px; border: 0; font-weight: 700; cursor: pointer; font-size: 14px; }
    .save-btn:hover, .cancel-btn:hover { background: #cbd5e1; }
    /* Draft notification modal */
    .draft-modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.6); display: none; align-items: center; justify-content: center; z-index: 10000; }
    .draft-modal-overlay.show { display: flex; }
    .draft-modal-content { background: #fff; width: 90%; max-width: 450px; border-radius: 12px; padding: 28px; box-shadow: 0 10px 40px rgba(14,17,17,.2); text-align: center; animation: slideDown 0.3s ease; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .draft-modal-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; color: #fff; }
    .draft-modal-title { font-size: 20px; font-weight: 700; margin-bottom: 12px; color: #0f172a; }
    .draft-modal-message { font-size: 14px; color: #64748b; margin-bottom: 24px; line-height: 1.6; }
    .draft-modal-actions { display: flex; gap: 12px; justify-content: center; }
    .draft-btn-primary { background: #2563eb; color: #fff; padding: 12px 24px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .draft-btn-primary:hover { background: #1d4ed8; }
    .draft-btn-secondary { background: #e2e8f0; color: #0f172a; padding: 12px 24px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .draft-btn-secondary:hover { background: #cbd5e1; }
    /* Success Modal */
    .success-modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
    .success-modal-overlay.show { display: flex; }
    .success-modal-content { background: #fff; width: 90%; max-width: 400px; border-radius: 12px; padding: 32px 24px; box-shadow: 0 10px 40px rgba(14,17,17,.2); text-align: center; animation: scaleIn 0.3s ease; }
    @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .success-icon { width: 72px; height: 72px; margin: 0 auto 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; }
    .success-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; color: #0f172a; }
    .success-message { font-size: 14px; color: #64748b; margin-bottom: 24px; }
    .success-btn { background: #10b981; color: #fff; padding: 12px 32px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; font-size: 14px; transition: background 0.2s; }
    .success-btn:hover { background: #059669; }
    /* Delete Confirmation Modal */
    .delete-modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
    .delete-modal-overlay.show { display: flex; }
    .delete-modal-dialog { background: #fff; width: 90%; max-width: 400px; border-radius: 12px; padding: 24px; box-shadow: 0 10px 40px rgba(14,17,17,.2); text-align: center; }
    .delete-modal-title { font-size: 18px; font-weight: 700; margin: 0 0 12px; color: #0f172a; }
    .delete-modal-text { font-size: 14px; color: #64748b; margin-bottom: 24px; line-height: 1.5; }
    .delete-modal-actions { display: flex; gap: 10px; justify-content: center; }
    .delete-confirm-btn { background: #ef4444; color: #fff; padding: 10px 24px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; }
    .delete-confirm-btn:hover { background: #dc2626; }
    .delete-cancel-btn { background: #e2e8f0; color: #0f172a; padding: 10px 24px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; }
    .delete-cancel-btn:hover { background: #cbd5e1; }
    #addProjectBtn { padding: 6px 12px; font-size: 13px; border-radius: 6px; }
    /* Tablet landscape */
          @media (max-width: 900px) {
      .table-wrapper {
        align-items: center;
      }
      .project-controls { 
        width: 100%;
        max-width: 650px; 
        margin: 0 0 8px 0; 
      }
      .container { margin: 12px 0 0 0; padding: 12px 8px 0 8px; }
      .brand-header button { padding: 4px 9px; font-size: 11px; }
      
      input, button { 
        padding: 5px 8px; 
        font-size: 12px; 
      }
      
      table {
        width: 100%;
        max-width: 650px;
        font-size: 11px;
      }
      
      th, td {
        padding: 6px 6px;
        font-size: 11px;
      }
      
      th:nth-child(1), td:nth-child(1) { width: 100px; }
      th:nth-child(2), td:nth-child(2) { width: 80px; }
      th:nth-child(3), td:nth-child(3) { width: 80px; }
      th:nth-child(4), td:nth-child(4) { width: 130px; }
      th:nth-child(5), td:nth-child(5) { width: 70px; }
      th:nth-child(6), td:nth-child(6) { width: 80px; }
      th:nth-child(7), td:nth-child(7) { width: 60px; }
      th:nth-child(8), td:nth-child(8) { width: 90px; }
    }

    /* Mobile phones - Hide some columns to save space */
    @media (max-width: 600px) {
      body { overflow-x: hidden; }
      
      .brand-header { padding: 16px 20px; }
      .brand-header h1 { font-size: 22px; }
      .brand-header button { padding: 4px 8px !important; font-size: 11px !important; min-width: 50px !important; }
      
      .container { 
        margin: 8px 0 0 0; 
        padding: 8px 4px 0 4px; 
      }
      
      .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      input, button { 
        width: 100%; 
        padding: 8px 10px;
        font-size: 13px;
      }
      
      .table-wrapper {
        padding-left: 0;
      }
      .project-controls {
        width: 100%;
        flex-direction: column;
        padding: 0 8px;
        max-width: 100%;
      }
      
      .project-controls input {
        max-width: 100%;
      }
      
      #addProjectBtn {
        max-width: 150px;
        align-self: center;
        padding: 6px 10px !important;
        font-size: 12px !important;
      }
      
      .table-center {
        width: 100%;
        margin: 0 -8px;
        padding: 0 8px;
        overflow-x: scroll;
      }
      
      table {
        font-size: 10px;
        width: 100%;
        max-width: 650px;
      }
      
      /* HIDE Industry and PIC columns on mobile */
      th:nth-child(5), td:nth-child(5),
      th:nth-child(7), td:nth-child(7) {
        display: none;
      }
      
      /* Adjust remaining column widths for compact mobile */
      th:nth-child(1), td:nth-child(1) { 
        width: 75px;
        padding: 6px 4px;
        font-size: 10px;
      }
      
      th:nth-child(2), td:nth-child(2) { 
        width: 90px;
        font-size: 9px;
      }
      
      th:nth-child(3), td:nth-child(3) { 
        width: 100px;
        font-size: 10px;
      }
      
      th:nth-child(4), td:nth-child(4) { 
        min-width: 140px;
        max-width: 200px;
        font-size: 10px;
      }
      
      th:nth-child(6), td:nth-child(6) { 
        width: 90px;
        font-size: 9px;
      }
      
      th:nth-child(8), td:nth-child(8) { 
        width: 100px;
      }
      
      thead th { 
        font-size: 9px;
        padding: 8px 4px;
        letter-spacing: 0.3px;
      }
      
      tbody td { 
        padding: 8px 4px;
      }
      
      .actions-cell button {
        padding: 5px 7px;
        font-size: 10px;
        margin-right: 4px;
      }
      
      /* Better scrollbar */
      .table-center::-webkit-scrollbar {
        height: 6px;
      }
      .table-center::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .table-center::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
      }
    }

    /* Very small phones */
    @media (max-width: 420px) {
      .brand-header h1 { font-size: 20px; }
      .brand-header button { padding: 3px 6px !important; font-size: 10px !important; min-width: 45px !important; }
      
      #addProjectBtn {
        max-width: 130px !important;
        padding: 5px 8px !important;
        font-size: 11px !important;
      }
      
      table {
        width: 100%;
        max-width: 650px;
      }
      
      th:nth-child(1), td:nth-child(1) { width: 70px; font-size: 9px; }
      th:nth-child(2), td:nth-child(2) { width: 70px; font-size: 8px; }
      th:nth-child(3), td:nth-child(3) { width: 80px; font-size: 9px; }
      th:nth-child(4), td:nth-child(4) { min-width: 100px; max-width: 150px; font-size: 9px; }
      th:nth-child(6), td:nth-child(6) { width: 70px; font-size: 8px; }
      th:nth-child(8), td:nth-child(8) { width: 80px; }
      
      thead th { font-size: 8px; padding: 6px 3px; }
      tbody td { font-size: 10px; padding: 6px 3px; }
      
      .actions-cell button { 
        padding: 4px 6px; 
        font-size: 9px;
        margin-right: 3px;
      }
    }
  </style>
  <script src="auth.js"></script>
  <script>
    function qs(id){ return document.getElementById(id); }
    async function ensureAdmin() {
      try {
        if (!window.DSRAuth || !DSRAuth.isLoggedIn()) {
          window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
          return false;
        }
        const me = await DSRAuth.me();
        if (!me.ok || !me.authenticated || !me.user || me.user.role !== 'admin') {
          alert('Admin access required');
          window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
          return false;
        }
        return true;
      } catch (_) {
        window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
        return false;
      }
    }

    function uniq(arr) { const s = new Set(); const out = []; for (const v of arr) { const sv = String(v||'').trim(); if (sv && !s.has(sv)) { s.add(sv); out.push(sv); } } return out; }

    // Global projects array - loaded from backend
    let projects = [];

    // Track if we're editing or adding
    let isEditMode = false;
    let editingProjectCode = null;

    // Fetch projects from backend
    async function fetchProjectsFromBackend() {
      try {
        const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
        const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs';
        const res = await fetch(url, { headers });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || ('HTTP ' + res.status));
        }
        return data.items || [];
      } catch (e) {
        console.error('Error fetching projects:', e);
        throw e;
      }
    }

    async function loadProjects() {
      // Fetch projects from backend first
      try {
        projects = await fetchProjectsFromBackend();
      } catch (e) {
        alert('Failed to load projects: ' + (e && e.message ? e.message : String(e)));
        projects = [];
      }
      const list = qs('list');
      list.innerHTML = '';

      const tableWrapper = document.createElement('div');
      tableWrapper.className = 'table-wrapper';

      const topBar = document.createElement('div');
      topBar.className = 'project-controls';
      topBar.innerHTML = `
        <input id="searchInput" type="text" placeholder="Search projects..." style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;max-width:250px;">
        <button id="addProjectBtn" style="background:#2563eb;color:#fff;border:0;font-weight:600;cursor:pointer;">+ Add Project</button>
      `;
      tableWrapper.appendChild(topBar);

      const tableWrap = document.createElement('div');
      tableWrap.className = 'table-center';
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Project Code</th>
            <th>PO/Start Date</th>
            <th>Client</th>
            <th>Project Name</th>
            <th>Industry</th>
            <th>Location</th>
            <th>PIC</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      
      function renderRows(rows) {
        tbody.innerHTML = '';
        for (const p of rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.code}</td>
            <td>${p.startDate}</td>
            <td>${p.client}</td>
            <td>${p.name}</td>
            <td>${p.industry}</td>
            <td>${p.location}</td>
            <td>${p.pic}</td>
            <td class=\"actions-cell\"><button data-act=\"delete\" data-code=\"${p.code}\">Delete</button><button data-act=\"edit\" data-code=\"${p.code}\">Edit</button></td>
          `;
          tbody.appendChild(tr);
        }
        
        // Add event listeners to all action buttons
        tbody.querySelectorAll('button[data-act]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.target.getAttribute('data-act');
            const code = e.target.getAttribute('data-code');
            if (action === 'edit') {
              editProject(code);
            } else if (action === 'delete') {
              deleteProject(code);
            }
          });
        });
      }
      
      renderRows(projects);
      tableWrap.appendChild(table);
      tableWrapper.appendChild(tableWrap);
      list.appendChild(tableWrapper);
      
      // Add search functionality
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim().toLowerCase();
          const filtered = projects.filter(p => 
            (p.code + ' ' + p.name + ' ' + p.client + ' ' + p.location).toLowerCase().includes(query)
          );
          renderRows(filtered);
        });
      }
    }

    function openAddProjectModal() {
      isEditMode = false;
      editingProjectCode = null;
      
      qs('projectCode').disabled = false; // Enable project code field for new projects
      
      // Try to load draft from localStorage
      const draft = loadDraft();
      if (draft) {
        // Show custom draft notification modal
        showDraftNotification(draft);
      } else {
        // No draft, clear form fields and open modal
        clearFormFields();
        openProjectFormModal();
      }
    }

    function openProjectFormModal() {
      // Update modal title
      qs('modalTitle').textContent = 'PROJECT DETAILS - ADD NEW';
      
      qs('addProjectModal').classList.add('show');
      
      // Enable auto-save for draft
      enableDraftAutoSave();
    }

    function showDraftNotification(draft) {
      // Show the draft notification modal
      qs('draftModal').classList.add('show');
    }

    function useDraftData() {
      if (isEditMode) {
        useEditDraftData();
      } else {
        const draft = loadDraft();
        if (draft) {
          // Load draft data
          qs('projectCode').value = draft.code || '';
          qs('startDate').value = draft.startDate || '';
          qs('clientName').value = draft.client || '';
          qs('projectName').value = draft.name || '';
          qs('industry').value = draft.industry || '';
          qs('location').value = draft.location || '';
          qs('pic').value = draft.pic || '';
        }
        
        // Close draft notification and open project form
        qs('draftModal').classList.remove('show');
        openProjectFormModal();
      }
    }

    function discardDraft() {
      if (isEditMode) {
        discardEditDraft();
      } else {
        // Clear draft and form
        clearDraft();
        clearFormFields();
        
        // Close draft notification and open project form
        qs('draftModal').classList.remove('show');
        openProjectFormModal();
      }
    }

    function clearFormFields() {
      qs('projectCode').value = '';
      qs('startDate').value = '';
      qs('clientName').value = '';
      qs('projectName').value = '';
      qs('industry').value = '';
      qs('location').value = '';
      qs('pic').value = '';
    }

    function editProject(code) {
      const project = projects.find(p => p.code === code);
      if (!project) {
        alert('Project not found!');
        return;
      }
      
      isEditMode = true;
      editingProjectCode = code;
      
      qs('projectCode').disabled = true; // Disable project code field when editing
      
      // Try to load edit draft for this specific project
      const editDraft = loadEditDraft(code);
      if (editDraft) {
        // Show custom draft notification modal for edit
        showEditDraftNotification(editDraft, project);
      } else {
        // No draft, load original project data
        loadProjectDataToForm(project);
        openEditFormModal();
      }
    }

    function loadProjectDataToForm(project) {
      qs('projectCode').value = project.code;
      qs('startDate').value = project.startDate;
      qs('clientName').value = project.client;
      qs('projectName').value = project.name;
      qs('industry').value = project.industry;
      qs('location').value = project.location;
      qs('pic').value = project.pic;
    }

    function openEditFormModal() {
      // Update modal title
      qs('modalTitle').textContent = 'PROJECT DETAILS - EDIT';
      
      qs('addProjectModal').classList.add('show');
      
      // Enable auto-save for draft in edit mode
      enableDraftAutoSave();
    }

    function showEditDraftNotification(draft, originalProject) {
      // Store original project for comparison
      window.originalProjectBeforeEdit = originalProject;
      
      // Show the draft notification modal
      qs('draftModal').classList.add('show');
    }

    function useEditDraftData() {
      const draft = loadEditDraft(editingProjectCode);
      if (draft) {
        // Load draft data
        qs('projectCode').value = draft.code;
        qs('startDate').value = draft.startDate || '';
        qs('clientName').value = draft.client || '';
        qs('projectName').value = draft.name || '';
        qs('industry').value = draft.industry || '';
        qs('location').value = draft.location || '';
        qs('pic').value = draft.pic || '';
      }
      
      // Close draft notification and open project form
      qs('draftModal').classList.remove('show');
      openEditFormModal();
    }

    function discardEditDraft() {
      // Load original project data
      const project = projects.find(p => p.code === editingProjectCode);
      if (project) {
        loadProjectDataToForm(project);
      }
      
      // Clear edit draft
      clearEditDraft(editingProjectCode);
      
      // Close draft notification and open project form
      qs('draftModal').classList.remove('show');
      openEditFormModal();
    }

    let projectToDelete = null;

    function deleteProject(code) {
      const project = projects.find(p => p.code === code);
      if (!project) {
        showSuccessModal('Error', 'Project not found!');
        return;
      }
      
      // Store project info for deletion
      projectToDelete = { code: code, name: project.name };
      
      // Show delete confirmation modal
      qs('deleteModalText').innerHTML = `Are you sure you want to delete project<br><strong>"${project.name}"</strong><br>(${code})?`;
      qs('deleteModal').classList.add('show');
    }

    async function confirmDelete() {
      if (projectToDelete) {
        const codeToDelete = projectToDelete.code;
        const nameToDelete = projectToDelete.name;
        
        // Optimistically remove the row from the DOM immediately for instant feedback
        const deleteButton = document.querySelector(`button[data-act="delete"][data-code="${codeToDelete}"]`);
        const rowToRemove = deleteButton ? deleteButton.closest('tr') : null;
        
        // Optimistically remove from local array immediately
        const deletedIndex = projects.findIndex(p => p.code === codeToDelete);
        let deletedProject = null;
        if (deletedIndex !== -1) {
          deletedProject = projects[deletedIndex];
          projects.splice(deletedIndex, 1);
        }
        
        // Close modal immediately for faster UI response
        qs('deleteModal').classList.remove('show');
        projectToDelete = null;
        
        // If row found, remove it immediately with animation
        if (rowToRemove) {
          rowToRemove.style.transition = 'opacity 0.2s ease-out';
          rowToRemove.style.opacity = '0';
          setTimeout(() => {
            rowToRemove.remove();
            // Check if table is empty
            const tbody = document.querySelector('.table-wrapper table tbody');
            if (tbody && tbody.children.length === 0) {
              tbody.innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center;padding:20px;">No projects found</td></tr>';
            }
          }, 200);
        }
        
        try {
          // Delete from backend
          const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs/' + encodeURIComponent(codeToDelete);
          const res = await fetch(url, { method: 'DELETE', headers });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          // Refresh projects in background without blocking UI
          loadProjects().catch(err => {
            console.error('Error refreshing projects after delete:', err);
          });
        } catch (e) {
          // If deletion failed, restore the project and refresh
          if (deletedProject && deletedIndex !== -1) {
            projects.splice(deletedIndex, 0, deletedProject);
          }
          loadProjects().catch(err => {
            console.error('Error refreshing projects after failed delete:', err);
          });
          alert('Failed to delete project: ' + (e && e.message ? e.message : String(e)));
        }
      }
    }

    function cancelDelete() {
      qs('deleteModal').classList.remove('show');
      projectToDelete = null;
    }

    function closeAddProjectModal() {
      qs('addProjectModal').classList.remove('show');
      
      const hasContent = qs('projectCode').value.trim() || 
                        qs('startDate').value.trim() || 
                        qs('clientName').value.trim() || 
                        qs('projectName').value.trim() || 
                        qs('industry').value.trim() || 
                        qs('location').value.trim() || 
                        qs('pic').value.trim();
      
      if (hasContent) {
        if (isEditMode && editingProjectCode) {
          // Save edit draft with project code
          saveEditDraft(editingProjectCode);
        } else {
          // Save add draft
          saveDraft();
        }
      }
      
      isEditMode = false;
      editingProjectCode = null;
    }

    // Draft management functions
    function saveDraft() {
      const draft = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      // Only save if at least one field has content
      const hasContent = Object.values(draft).some(val => val && val !== draft.timestamp);
      if (hasContent) {
        localStorage.setItem('projectDraft', JSON.stringify(draft));
      }
    }

    function loadDraft() {
      try {
        const draftStr = localStorage.getItem('projectDraft');
        if (draftStr) {
          return JSON.parse(draftStr);
        }
      } catch (e) {
        console.error('Error loading draft:', e);
      }
      return null;
    }

    function clearDraft() {
      localStorage.removeItem('projectDraft');
    }

    // Edit draft management functions
    function saveEditDraft(projectCode) {
      const draft = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      // Only save if at least one field has content
      const hasContent = Object.values(draft).some(val => val && val !== draft.timestamp);
      if (hasContent) {
        localStorage.setItem(`projectEditDraft_${projectCode}`, JSON.stringify(draft));
      }
    }

    function loadEditDraft(projectCode) {
      try {
        const draftStr = localStorage.getItem(`projectEditDraft_${projectCode}`);
        if (draftStr) {
          return JSON.parse(draftStr);
        }
      } catch (e) {
        console.error('Error loading edit draft:', e);
      }
      return null;
    }

    function clearEditDraft(projectCode) {
      localStorage.removeItem(`projectEditDraft_${projectCode}`);
    }

    function enableDraftAutoSave() {
      // Auto-save draft as user types (works for both add and edit modes)
      const fields = ['projectCode', 'startDate', 'clientName', 'projectName', 'industry', 'location', 'pic'];
      fields.forEach(fieldId => {
        const field = qs(fieldId);
        if (field) {
          // Remove existing listeners to avoid duplicates
          const newField = field.cloneNode(true);
          field.parentNode.replaceChild(newField, field);
          
          newField.addEventListener('input', () => {
            if (isEditMode && editingProjectCode) {
              saveEditDraft(editingProjectCode);
            } else if (!isEditMode) {
              saveDraft();
            }
          });
        }
      });
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      const addModal = qs('addProjectModal');
      const deleteModal = qs('deleteModal');
      const successModal = qs('successModal');
      
      if (addModal && e.target === addModal) {
        closeAddProjectModal();
      } else if (deleteModal && e.target === deleteModal) {
        cancelDelete();
      } else if (successModal && e.target === successModal) {
        closeSuccessModal();
      }
    });

    // Close modals on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const draftModal = qs('draftModal');
        const deleteModal = qs('deleteModal');
        const successModal = qs('successModal');
        
        if (draftModal && draftModal.classList.contains('show')) {
          discardDraft();
        } else if (deleteModal && deleteModal.classList.contains('show')) {
          cancelDelete();
        } else if (successModal && successModal.classList.contains('show')) {
          closeSuccessModal();
        }
      }
    });

    async function saveProject() {
      const projectData = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim()
      };

      // Validate required fields
      if (!projectData.code || !projectData.startDate || !projectData.client || !projectData.name || !projectData.industry || !projectData.location || !projectData.pic) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const headers = Object.assign(
          { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {})
        );

        if (isEditMode) {
          // Edit existing project via PUT
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs/' + encodeURIComponent(editingProjectCode);
          const res = await fetch(url, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(projectData)
          });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          console.log('Project updated:', projectData);
          
          // Clear edit draft after successful update
          clearEditDraft(editingProjectCode);
          
          // Close modal first
          closeAddProjectModal();
          
          // Show success message
          showSuccessModal('Project Updated Successfully!', `"${projectData.name}" has been updated.`);
          
          // Reload the projects list from backend
          await loadProjects();
        } else {
          // Add new project via POST
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs';
          const res = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(projectData)
          });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          console.log('Project added:', projectData);
          
          // Clear draft after successful save
          clearDraft();
          
          // Close modal first
          closeAddProjectModal();
          
          // Show success message
          showSuccessModal('Project Added Successfully!', `"${projectData.name}" has been added to the project list.`);
          
          // Reload the projects list from backend
          await loadProjects();
        }
      } catch (e) {
        alert('Failed to save project: ' + (e && e.message ? e.message : String(e)));
      }
    }

    function showSuccessModal(title, message) {
      qs('successTitle').textContent = title;
      qs('successMessage').textContent = message;
      qs('successModal').classList.add('show');
      
      // Auto-close after 3 seconds
      setTimeout(() => {
        closeSuccessModal();
      }, 3000);
    }

    function closeSuccessModal() {
      qs('successModal').classList.remove('show');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      if (!(await ensureAdmin())) return;
      qs('backBtn').addEventListener('click', () => { window.location.replace('admin.html'); });
      
      // Add Project button click handler
      setTimeout(() => {
        const addBtn = qs('addProjectBtn');
        if (addBtn) {
          addBtn.addEventListener('click', openAddProjectModal);
        }
      }, 100);
      
      try { await loadProjects(); } catch (e) { alert('Failed to load projects: ' + (e && e.message ? e.message : String(e))); }
    });
  </script>
</head>
<body>
  <div class="brand-header">
    <h1>Project List</h1>
    <button id="backBtn" class="secondary" style="background:#e2e8f0;color:#0f172a;cursor:pointer;">Back</button>
  </div>
  <div class="container">
    <div id="list">
      <div class="muted">Loading‚Ä¶</div>
    </div>
  </div>
  <!-- Success Modal -->
  <div id="successModal" class="success-modal-overlay" role="dialog" aria-modal="true">
    <div class="success-modal-content">
      <div class="success-icon">‚úì</div>
      <h3 id="successTitle" class="success-title">Success!</h3>
      <p id="successMessage" class="success-message">Operation completed successfully.</p>
      <button type="button" class="success-btn" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="delete-modal-overlay" role="dialog" aria-modal="true">
    <div class="delete-modal-dialog">
      <p class="delete-modal-title">Delete Project?</p>
      <p id="deleteModalText" class="delete-modal-text">Are you sure you want to delete this project?</p>
      <div class="delete-modal-actions">
        <button type="button" class="delete-confirm-btn" onclick="confirmDelete()">YES</button>
        <button type="button" class="delete-cancel-btn" onclick="cancelDelete()">NO</button>
      </div>
    </div>
  </div>

  <!-- Draft Notification Modal -->
  <div id="draftModal" class="draft-modal-overlay" role="dialog" aria-modal="true">
    <div class="draft-modal-content">
      <div class="draft-modal-icon">üìù</div>
      <h3 class="draft-modal-title">Unsaved Draft Found</h3>
      <p class="draft-modal-message">You have an unfinished project form. Would you like to continue editing it or start fresh?</p>
      <div class="draft-modal-actions">
        <button type="button" class="draft-btn-primary" onclick="useDraftData()">Continue Editing</button>
        <button type="button" class="draft-btn-secondary" onclick="discardDraft()">Start Fresh</button>
      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div id="addProjectModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 id="modalTitle">PROJECT DETAILS</h2>
      </div>
      <div class="modal-body">
        <form id="projectForm" onsubmit="event.preventDefault(); saveProject();">
          <div class="form-group">
            <label for="projectCode">Project Code:</label>
            <input type="text" id="projectCode" required>
          </div>
          <div class="form-group">
            <label for="startDate">PO/ Start Date:</label>
            <input type="text" id="startDate" placeholder="MM/DD/YYYY" required>
          </div>
          <div class="form-group">
            <label for="clientName">Client Name:</label>
            <input type="text" id="clientName" required>
          </div>
          <div class="form-group">
            <label for="projectName">Project Name:</label>
            <input type="text" id="projectName" required>
          </div>
          <div class="form-group">
            <label for="industry">Industry:</label>
            <input type="text" id="industry" required>
          </div>
          <div class="form-group">
            <label for="location">Location:</label>
            <input type="text" id="location" required>
          </div>
          <div class="form-group">
            <label for="pic">PIC:</label>
            <input type="text" id="pic" required>
          </div>
          <div class="modal-actions">
            <button type="submit" class="save-btn">SAVE</button>
            <button type="button" class="cancel-btn" onclick="closeAddProjectModal()">CANCEL</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(() => {}); }
  </script>
</body>
</html>


