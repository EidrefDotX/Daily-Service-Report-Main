<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Daily Service Report</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    * { font-family: Helvetica, Arial, sans-serif !important; }
    body, html { font-family: Helvetica, Arial, sans-serif !important; margin: 0; background: #f6f7fb; color: #0f172a; }
    input, select, button, textarea, table, th, td, p, span, div, label, legend, h1, h2, h3, h4, h5, h6, a, li, ul, ol, option, caption, thead, tbody, tfoot, tr, small, strong, em, b, i, u, s, code, pre, blockquote, cite, abbr, acronym, dfn, kbd, samp, var, time, mark, ins, del, sub, sup { font-family: Helvetica, Arial, sans-serif !important; }
    .brand-header { 
      background: #0e1111; 
      color: #fff; 
      padding: 20px 24px; 
      text-align: left; 
      margin: 0; 
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand-logo { height: 32px; width: auto; display: block; }
    .brand-header h1 { 
      margin: 0 !important; 
      font-size: 28px !important; 
      font-weight: 700 !important; 
      letter-spacing: 1px !important; 
      font-family: Helvetica, Arial, sans-serif !important; 
      text-transform: none !important;
      color: #fff !important;
      border-bottom: none !important;
      padding-bottom: 0 !important;
    }
    .container { 
      max-width: 860px; 
      margin: 24px auto; 
      background: #ffffff; 
      padding: 32px; 
      border-radius: 0; 
      box-shadow: 0 4px 20px rgba(14, 17, 17, 0.1);
      border: 3px solid #0e1111;
    }
    h1 { 
      margin: 0 0 24px; 
      font-size: 26px; 
      color: #0e1111; 
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 3px solid #0e1111;
      padding-bottom: 12px;
    }
    /* Outstanding Black & White Form Design */
    fieldset { 
      border: 3px solid #0e1111; 
      border-radius: 0; 
      padding: 24px; 
      margin-bottom: 24px; 
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(14, 17, 17, 0.08);
      position: relative;
    }
    legend { 
      padding: 0 16px; 
      color: #0e1111; 
      font-weight: 800; 
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1.2px;
      background: #ffffff;
      border: 2px solid #0e1111;
      border-radius: 0;
    }
    label { 
      display: block; 
      font-size: 13px; 
      color: #0e1111; 
      margin-top: 16px; 
      margin-bottom: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    label:first-child {
      margin-top: 0;
    }
    input[type="text"], input[type="date"], input[type="time"], textarea, select { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #0e1111; 
      border-radius: 0; 
      font-size: 14px; 
      box-sizing: border-box; 
      background: #ffffff; 
      color: #0e1111;
      font-weight: 400;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    input[type="text"]:focus, input[type="date"]:focus, input[type="time"]:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #0e1111;
      box-shadow: inset 0 0 0 2px #0e1111, 0 0 0 3px rgba(14, 17, 17, 0.1);
      background: #fafafa;
    }
    input[type="text"]:hover, input[type="date"]:hover, input[type="time"]:hover, textarea:hover, select:hover {
      border-color: #1a1a1a;
      background: #fafafa;
    }
    /* Error states for validation */
    input.error, textarea.error, select.error {
      border-color: #ef4444 !important;
      border-width: 3px !important;
      background-color: #fef2f2 !important;
      animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .error-message {
      color: #ef4444;
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .field-wrapper {
      position: relative;
    }
    /* Compact, adaptive inputs for duration readouts */
    input.duration-input { 
      width: auto; 
      min-width: 12ch; 
      max-width: 100%; 
      display: inline-block;
      background: #fafafa;
      border: 2px solid #0e1111;
      font-weight: 600;
    }
    input:disabled { 
      background: #f5f5f5; 
      color: #0e1111; 
      border-color: #0e1111; 
      cursor: not-allowed;
      opacity: 0.7;
      border-style: dashed;
    }
    select:disabled { 
      background: #f5f5f5; 
      color: #0e1111; 
      border-color: #0e1111; 
      cursor: default; 
      opacity: 0.7;
      border-style: dashed;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none;
      pointer-events: none;
    }
    textarea { 
      min-height: 90px; 
      resize: vertical;
      font-family: Helvetica, Arial, sans-serif !important;
      line-height: 1.6;
    }
    .row { 
      display: grid; 
      grid-template-columns: repeat(2, minmax(0,1fr)); 
      gap: 20px; 
    }
    .actions { 
      display: flex; 
      gap: 16px; 
      margin-top: 32px; 
      justify-content: center;
    }
    button { 
      appearance: none; 
      border: 3px solid #0e1111; 
      background: #0e1111; 
      color: #ffffff; 
      padding: 14px 32px; 
      border-radius: 0; 
      font-weight: 700; 
      font-size: 14px;
      letter-spacing: 1px;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(14, 17, 17, 0.2);
      position: relative;
      overflow: hidden;
    }
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    button:hover {
      background: #1a1a1a;
      border-color: #1a1a1a;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(14, 17, 17, 0.3);
    }
    button:hover::before {
      width: 400px;
      height: 400px;
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(14, 17, 17, 0.2);
    }
    button.secondary { 
      background: #ffffff; 
      color: #0e1111;
      border: 3px solid #0e1111;
    }
    button.secondary:hover {
      background: #f5f5f5;
      border-color: #0e1111;
    }
    small.muted { color: #64748b; }
    .toast { 
      margin-top: 20px; 
      font-weight: 700; 
      font-size: 14px;
      padding: 12px 16px;
      border: 2px solid #0e1111;
      background: #ffffff;
      color: #0e1111;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 0;
      text-align: center;
    }
    .hidden { display: none; }
    .topbar { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .meta { display: flex; gap: 8px; align-items: center; font-size: 12px; color: #475569; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .user-info { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
    .user-name { font-weight: 600; color: #0e1111; font-family: Helvetica, Arial, sans-serif !important; }
    .logout-btn { background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 0; font-weight: 600; }
    /* Burger menu */
    .burger-btn { background: transparent; border: 0; width: 36px; height: 28px; padding: 4px; cursor: pointer; display: inline-flex; flex-direction: column; justify-content: space-between; }
    .burger-btn .line { width: 100%; height: 2px; background: #fff; border-radius: 2px; }
    .menu-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.4); display: none; z-index: 999; }
    .menu-overlay.show { display: block; }
    .side-menu { position: fixed; top: 0; right: -200px; width: 180px; height: 100%; background: #fff; color: #0f172a; box-shadow: -10px 0 24px rgba(2,6,23,0.12); transition: right .25s ease, opacity .25s ease; z-index: 1000; padding: 16px; border-radius: 16px 0 0 16px; display: none; visibility: hidden; opacity: 0; font-family: Helvetica, Arial, sans-serif !important; }
    .side-menu.show { right: 0; display: block; visibility: visible; opacity: 1; }
    .side-menu .menu-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; font-family: Helvetica, Arial, sans-serif !important; }
    .side-menu .menu-item:hover { background: #cbd5e1; }
    .protection-badge { display: inline-flex; align-items: center; gap: 4px; background: #10b981; color: #fff; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; margin-left: 0; }
    .protection-badge .dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    /* Logout confirmation modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.5); display: flex; align-items: center; justify-content: center; z-index: 9999; }
    .modal-overlay.hidden { display: none; }
    .modal-dialog { background: #fff; width: 90%; max-width: 360px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(14,17,17,.15); text-align: center; font-family: Helvetica, Arial, sans-serif !important; }
    .modal-dialog p { margin: 0 0 12px; color: #0e1111; font-weight: 600; font-family: Helvetica, Arial, sans-serif !important; }
    .modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 8px; }
    .modal-actions .yes-btn { background: #ef4444; color: #fff; padding: 10px 14px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; }
    .modal-actions .no-btn { background: #e2e8f0; color: #0e1111; padding: 10px 14px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; }
    .modal-actions .ok-btn { background: #10b981; color: #fff; padding: 10px 24px; border-radius: 8px; border: 0; font-weight: 700; cursor: pointer; }
    /* History modal */
    .history-modal-overlay { position: fixed; inset: 0; background: rgba(14,17,17,.6); display: none; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(2px); }
    .history-modal-overlay.show { display: flex; }
    .history-modal-dialog { 
      background: #ffffff; 
      width: 95%; 
      max-width: 1000px; 
      max-height: 90vh; 
      border-radius: 0; 
      padding: 24px; 
      box-shadow: 0 8px 32px rgba(14, 17, 17, 0.15); 
      border: 3px solid #0e1111;
      display: flex; 
      flex-direction: column; 
    }
    .history-modal-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 12px; 
      padding-bottom: 0; 
    }
    .history-modal-header h2 { 
      margin: 0; 
      font-size: 26px; 
      font-weight: 800; 
      color: #0e1111;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .history-modal-body { flex: 1; overflow-y: auto; overflow-x: auto; }
    .history-modal-body::-webkit-scrollbar { width: 10px; height: 10px; }
    .history-modal-body::-webkit-scrollbar-track { background: #ffffff; border-left: 1px solid #0e1111; }
    .history-modal-body::-webkit-scrollbar-thumb { background: #0e1111; border-radius: 0; border: 1px solid #0e1111; }
    .history-modal-body::-webkit-scrollbar-thumb:hover { background: #1a1a1a; }
    /* Outstanding Black & White Table Design */
    .history-table { 
      width: 100%; 
      border-collapse: separate; 
      border-spacing: 0; 
      min-width: 700px;
      background: #ffffff;
      border: 2px solid #0e1111;
      border-radius: 0;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(14, 17, 17, 0.1);
    }
    .history-table th, .history-table td { 
      padding: 16px 20px; 
      text-align: left; 
      font-size: 14px;
      border-right: 1px solid #e5e7eb;
    }
    .history-table th:last-child, .history-table td:last-child {
      border-right: none;
    }
    .history-table th { 
      background: #0e1111;
      font-weight: 700; 
      text-transform: uppercase; 
      font-size: 12px; 
      letter-spacing: 1.2px; 
      color: #ffffff; 
      position: sticky; 
      top: 0; 
      z-index: 10; 
      border-bottom: 3px solid #0e1111;
      white-space: nowrap;
      text-shadow: 0 1px 2px rgba(14, 17, 17, 0.3);
      box-shadow: 0 2px 4px rgba(14, 17, 17, 0.1);
    }
    .history-table th:first-child { 
      border-top-left-radius: 0;
      border-left: none;
    }
    .history-table th:last-child { 
      border-top-right-radius: 0;
      border-right: none;
    }
    .history-table tbody tr { 
      border-bottom: 1px solid #0e1111;
      background: #ffffff;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .history-table tbody tr:last-child { 
      border-bottom: none; 
    }
    .history-table tbody tr:hover { 
      background: #f9fafb;
      box-shadow: inset 4px 0 0 #0e1111;
      transform: translateX(2px);
    }
    .history-table tbody tr:nth-child(even) { 
      background: #ffffff;
    }
    .history-table tbody tr:nth-child(even):hover { 
      background: #f3f4f6;
      box-shadow: inset 4px 0 0 #0e1111;
    }
    .history-table tbody tr:nth-child(odd) {
      background: #fafafa;
    }
    .history-table tbody tr:nth-child(odd):hover {
      background: #f3f4f6;
    }
    .history-table td { 
      color: #0e1111; 
      vertical-align: middle;
      font-weight: 400;
      border-color: #e5e7eb;
    }
    .history-table td:first-child { 
      font-weight: 700; 
      color: #0e1111;
      font-size: 15px;
      letter-spacing: 0.5px;
    }
    .history-brand-header {
      background: #0e1111;
      color: #fff;
      padding: 18px 24px;
      margin-bottom: 20px;
      border-radius: 0;
      border: 2px solid #0e1111;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .history-brand-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      text-transform: none;
      letter-spacing: 0.3px;
    }
    .history-brand-close {
      background: transparent;
      border: 2px solid #fff;
      color: #fff;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 8px 16px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .history-brand-close:hover {
      background: #fff;
      color: #0e1111;
    }
    .history-brand-meta {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 1px;
      color: #cbd5f5;
    }
    .history-brand-badge {
      font-size: 11px;
      font-weight: 700;
      padding: 6px 12px;
      border: 2px solid #fff;
      border-radius: 999px;
      letter-spacing: 1px;
    }
    .history-table .view-btn { 
      background: #0e1111; 
      color: #ffffff; 
      border: 2px solid #0e1111;
      padding: 10px 20px; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px; 
      font-weight: 700; 
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(14, 17, 17, 0.2);
      position: relative;
      overflow: hidden;
    }
    .history-table .view-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    .history-table .view-btn:hover { 
      background: #1a1a1a;
      border-color: #1a1a1a;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(14, 17, 17, 0.3);
    }
    .history-table .view-btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .history-table .view-btn:active { 
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(14, 17, 17, 0.2);
    }
    .history-table .print-btn {
      background: #0e1111;
      color: #ffffff;
      border: 2px solid #0e1111;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      font-weight: 400;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(14, 17, 17, 0.2);
      position: relative;
      overflow: hidden;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .history-table .print-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }
    .history-table .print-btn:hover {
      background: #1a1a1a;
      border-color: #1a1a1a;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(14, 17, 17, 0.25);
    }
    .history-table .print-btn:hover::before {
      width: 200px;
      height: 200px;
    }
    .history-table .print-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(14, 17, 17, 0.2);
    }
    .print-btn-modal {
      background: #0e1111;
      color: #ffffff;
      border: 2px solid #0e1111;
      padding: 0;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 1px 3px rgba(14, 17, 17, 0.2);
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .print-btn-modal:hover {
      background: #1a1a1a;
      border-color: #1a1a1a;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(14, 17, 17, 0.25);
    }
    .print-btn-modal:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(14, 17, 17, 0.2);
    }
    .history-empty { 
      text-align: center; 
      padding: 60px 20px; 
      color: #0e1111; 
      font-size: 15px; 
      line-height: 1.6;
      font-weight: 500;
      background: #ffffff;
      border: 1px dashed #0e1111;
      border-radius: 4px;
      margin: 20px;
    }
    /* Draft restore modal */
    .draft-restore-modal { position: fixed; inset: 0; background: rgba(14,17,17,.6); display: none; align-items: center; justify-content: center; z-index: 10000; backdrop-filter: blur(3px); animation: fadeIn 0.2s ease; }
    .draft-restore-modal.show { display: flex; }
    .draft-restore-dialog { background: #fff; width: 90%; max-width: 480px; border-radius: 16px; padding: 32px; box-shadow: 0 20px 60px rgba(14,17,17,.3); animation: slideUp 0.3s ease; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-title { font-size: 22px; font-weight: 700; color: #0f172a; margin: 0; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-message { color: #475569; font-size: 15px; line-height: 1.6; margin: 16px 0; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-timestamp { background: #f1f5f9; padding: 12px 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #10b981; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-timestamp strong { color: #0f172a; font-size: 14px; display: block; margin-bottom: 4px; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-timestamp span { color: #64748b; font-size: 13px; font-family: Helvetica, Arial, sans-serif !important; }
    .draft-restore-actions { display: flex; gap: 12px; margin-top: 24px; }
    .draft-restore-actions button { flex: 1; padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; border: 0; transition: all 0.2s ease; }
    .draft-restore-btn { background: #10b981; color: #fff; }
    .draft-restore-btn:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
    .draft-discard-btn { background: #f1f5f9; color: #475569; }
    .draft-discard-btn:hover { background: #e2e8f0; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    /* Responsive layout */
    /* ========================================
       RESPONSIVE DESIGN - MOBILE & TABLET
       ======================================== */
    
    /* Tablet and Mobile (up to 768px) */
    @media screen and (max-width: 768px) {
      /* Header */
      .brand-header { 
        padding: 12px 16px; 
        flex-wrap: wrap;
      }
      .brand-header h1 { 
        font-size: 20px !important; 
        flex: 1;
        min-width: 0;
      }
      
      /* Container */
      .container { 
        margin: 12px 8px; 
        padding: 20px 16px; 
        border: 3px solid #0e1111; 
      }
      
      /* Headings */
      h1 { 
        font-size: 20px; 
        padding-bottom: 10px; 
        margin-bottom: 16px;
      }
      
      /* Form fields */
      fieldset { 
        padding: 16px; 
        margin-bottom: 16px; 
      }
      legend { 
        font-size: 11px; 
        padding: 0 10px; 
      }
      label { 
        font-size: 12px; 
        margin-top: 12px; 
        margin-bottom: 6px;
      }
      input[type="text"], 
      input[type="date"], 
      input[type="time"], 
      textarea, 
      select { 
        padding: 12px 14px; 
        font-size: 16px; /* Prevents iOS zoom */
        border-width: 2px;
      }
      
      /* Grid layout - stack on mobile */
      .row { 
        grid-template-columns: 1fr; 
        gap: 16px;
      }
      
      /* Topbar */
      .topbar { 
        flex-direction: column; 
        align-items: stretch; 
        gap: 12px; 
      }
      
      /* Buttons */
      button { 
        width: 100%; 
        padding: 14px 24px; 
        font-size: 14px;
        min-height: 48px;
      }
      .actions { 
        flex-direction: column;
        gap: 12px;
      }
      .actions button {
        width: 100%;
      }
      
      /* Signature canvas */
      canvas { 
        height: 120px; 
        width: 100%;
      }
      
      /* Modals */
      .modal-dialog { 
        width: 95%; 
        max-width: 95%;
        padding: 16px;
        margin: 10px;
      }
      .modal-actions {
        flex-direction: column;
        gap: 10px;
      }
      .modal-actions button {
        width: 100%;
      }
      
      /* History modal */
      .history-modal-dialog { 
        width: 98%; 
        max-width: 98%;
        max-height: 95vh; 
        padding: 12px; 
        border-radius: 8px;
        margin: 5px;
      }
      .history-modal-header { 
        margin-bottom: 12px; 
        padding-bottom: 12px; 
        flex-wrap: wrap;
      }
      .history-modal-header h2 { 
        font-size: 18px; 
      }
      .history-modal-body {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .history-table { 
        min-width: 700px; 
        font-size: 11px;
      }
      .history-table th, 
      .history-table td { 
        padding: 10px 8px; 
        font-size: 11px; 
      }
      .history-table th { 
        font-size: 9px; 
        letter-spacing: 0.8px; 
        padding: 10px 8px;
      }
      .history-table .view-btn { 
        padding: 8px 14px; 
        font-size: 11px; 
        min-height: 36px;
      }
      .history-table td:first-child { 
        font-size: 12px; 
      }
      
      /* Protection badge */
      .protection-badge { 
        margin-left: 0; 
        margin-top: 8px; 
        display: inline-flex; 
      }
      
      /* Draft restore modal */
      .draft-restore-dialog { 
        padding: 20px; 
        max-width: 95%; 
      }
      .draft-restore-icon { 
        width: 50px; 
        height: 50px; 
        font-size: 24px; 
      }
      .draft-restore-title { 
        font-size: 18px; 
      }
      .draft-restore-message { 
        font-size: 13px; 
      }
      .draft-restore-timestamp { 
        padding: 10px 12px; 
        font-size: 12px; 
      }
      .draft-restore-actions { 
        flex-direction: column; 
        gap: 10px;
      }
      .draft-restore-actions button { 
        width: 100%;
        padding: 12px;
        min-height: 48px;
      }
      
      /* User info in topbar */
      .user-info {
        flex-wrap: wrap;
        justify-content: flex-start;
      }
      .logout-btn {
        width: 100%;
        margin-top: 8px;
        padding: 10px;
        min-height: 44px;
      }
    }
    
    /* Small mobile devices (up to 480px) */
    @media screen and (max-width: 480px) {
      .brand-header { 
        padding: 10px 12px; 
      }
      .brand-header h1 { 
        font-size: 18px !important; 
      }
      .container { 
        margin: 8px 4px; 
        padding: 16px 12px; 
      }
      h1 { 
        font-size: 18px; 
        padding-bottom: 8px;
        margin-bottom: 12px;
      }
      fieldset { 
        padding: 12px; 
        margin-bottom: 12px; 
      }
      legend { 
        font-size: 10px; 
        padding: 0 8px; 
      }
      label { 
        font-size: 11px; 
        margin-top: 10px;
      }
      input[type="text"], 
      input[type="date"], 
      input[type="time"], 
      textarea, 
      select { 
        padding: 10px 12px; 
        font-size: 16px;
      }
      canvas { 
        height: 100px; 
      }
      .history-modal-dialog { 
        padding: 8px; 
        width: 100%;
        max-width: 100%;
        margin: 0;
        border-radius: 0;
      }
      .history-table { 
        min-width: 600px; 
      }
      .history-table th, 
      .history-table td { 
        padding: 8px 6px; 
        font-size: 10px; 
      }
      .history-table th { 
        font-size: 8px; 
      }
      .draft-restore-dialog { 
        padding: 16px; 
      }
    }
    
    /* Touch-friendly inputs on mobile devices */
    @media (hover: none) and (pointer: coarse) {
      input[type="text"], 
      input[type="date"], 
      input[type="time"], 
      textarea, 
      select {
        min-height: 44px;
        font-size: 16px; /* Prevents iOS zoom on focus */
      }
      button {
        min-height: 48px;
        padding: 14px 20px;
      }
      .burger-btn {
        min-width: 44px;
        min-height: 44px;
        padding: 8px;
      }
    }
    
    /* Landscape mobile orientation */
    @media screen and (max-width: 768px) and (orientation: landscape) {
      .container {
        margin: 8px;
        padding: 16px;
      }
      fieldset {
        padding: 12px;
      }
      .row {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
  <script src="auth.js"></script>
  <script>
    // DSR Application - No hard auth gate; allow access
    window._logoutBtnRef = null;
    window.openLogoutConfirm = function (event, btn) {
      try { if (event && typeof event.preventDefault === 'function') event.preventDefault(); } catch (_) {}
      try { window._logoutBtnRef = btn || null; } catch (_) { window._logoutBtnRef = null; }
      const overlay = document.getElementById('logoutOverlay');
      if (overlay) overlay.classList.remove('hidden');
    };
    window.cancelLogout = function () {
      const overlay = document.getElementById('logoutOverlay');
      if (overlay) overlay.classList.add('hidden');
    };
    window.confirmLogout = function () {
      const overlay = document.getElementById('logoutOverlay');
      if (overlay) overlay.classList.add('hidden');
      // Proceed with actual logout
      try { window.logout(null, window._logoutBtnRef); } catch (_) { window.location.href = 'login.html'; }
    };
    window.closeSuccessModal = function () {
      const overlay = document.getElementById('successOverlay');
      if (overlay) overlay.classList.add('hidden');
      // Reset form after closing success modal
      const form = document.getElementById('dsrForm');
      if (form) form.reset();
      // Clear proper logout flag to allow draft restore for next form if user closes accidentally
      localStorage.removeItem('dsr_proper_logout');
    };
    window.logout = async function (event, btn) {
      try { if (event && typeof event.preventDefault === 'function') event.preventDefault(); } catch (_) {}
      try { if (btn) { btn.disabled = true; btn.textContent = 'Logging out...'; } } catch (_) {}
      try {
        // Mark that user logged out properly - clear draft to avoid restore popup
        localStorage.setItem('dsr_proper_logout', 'true');
        clearDraft(); // Clear draft on proper logout
        
        // Best-effort server logout with timeout; always clear client state
        const doLogout = (async () => {
          if (window.DSRAuth && typeof window.DSRAuth.logout === 'function') {
            await window.DSRAuth.logout();
          }
        })();
        const timeout = new Promise((resolve) => setTimeout(resolve, 1500));
        await Promise.race([doLogout, timeout]);
      } catch (e) {
        console.error('Error during server logout:', e);
      }
      try { localStorage.removeItem('dsr_session'); } catch (e) { console.error('Error removing session:', e); }
      try { localStorage.removeItem('dsr_jwt_token'); } catch (e) { console.error('Error removing token:', e); }
      try { sessionStorage.removeItem('dsr_redirect_to'); } catch (e) { console.error('Error removing redirect:', e); }
      // Prevent back button from returning to protected page
      try { window.location.replace('/login.html'); } catch (e) { 
        console.error('Error replacing location:', e);
        window.location.href = '/login.html'; 
      }
    };
  </script>
  <script>
    // Draft persistence helpers

    // Auto-save draft functionality
    const DRAFT_KEY = 'dsr_form_draft';
    const DRAFT_TIMESTAMP_KEY = 'dsr_form_draft_timestamp';
    
    // Configuration constants
    const MIN_IMPORTANT_FIELDS_FOR_DRAFT = 3; // Minimum filled fields to show draft restore
    const DRAFT_LOAD_DELAY_MS = 500; // Delay before checking for draft on page load
    const AUTO_SAVE_DEBOUNCE_MS = 2000; // Debounce time for auto-save
    const AUTO_SAVE_QUICK_DEBOUNCE_MS = 500; // Quick debounce for select/date changes
    const AUTO_SAVE_INTERVAL_MS = 30000; // Periodic auto-save every 30 seconds
    const SERVICE_WORKER_CACHE_INTERVAL_MS = 60000; // Cache draft via SW every minute
    
    let autoSaveTimer = null;

    function saveDraft() {
      try {
        const formData = {
          reportDate: document.getElementById('reportDate')?.value || '',
          projectPhase: document.getElementById('projectPhase')?.value || '',
          projectPhaseCustom: document.getElementById('projectPhaseCustom')?.value || '',
          projectPhaseCustomVisible: document.getElementById('projectPhaseCustom')?.style.display !== 'none',
          engineerNumber: document.getElementById('engineerNumber')?.value || '',
          engineerName: document.getElementById('engineerName')?.value || '',
          projectCode: document.getElementById('projectCode')?.value || '',
          projectCodeCustom: document.getElementById('projectCodeCustom')?.value || '',
          projectCodeCustomVisible: document.getElementById('projectCodeCustom')?.style.display !== 'none',
          projectName: document.getElementById('projectName')?.value || '',
          clientName: document.getElementById('clientName')?.value || '',
          plantLocation: document.getElementById('plantLocation')?.value || '',
          travelTimeToSite: document.getElementById('travelTimeToSite')?.value || '',
          travelTimeFromSite: document.getElementById('travelTimeFromSite')?.value || '',
          onSiteTimeIn: document.getElementById('onSiteTimeIn')?.value || '',
          onSiteTimeOut: document.getElementById('onSiteTimeOut')?.value || '',
          homeTravelStart: document.getElementById('homeTravelStart')?.value || '',
          homeTravelEnd: document.getElementById('homeTravelEnd')?.value || '',
          workObjective: document.getElementById('workObjective')?.value || '',
          description: document.getElementById('description')?.value || '',
          outcome: document.getElementById('outcome')?.value || ''
        };

        // Only save if there's actual data
        const hasData = Object.values(formData).some(val => val && val !== '');
        if (hasData) {
          localStorage.setItem(DRAFT_KEY, JSON.stringify(formData));
          localStorage.setItem(DRAFT_TIMESTAMP_KEY, new Date().toISOString());
          console.log('Draft saved at', new Date().toLocaleTimeString());
        }
      } catch (e) {
        console.error('Error saving draft:', e);
      }
    }

    function loadDraft() {
      try {
        // Check if user logged out properly - if yes, don't show draft restore
        const properLogout = localStorage.getItem('dsr_proper_logout');
        if (properLogout === 'true') {
          console.log('User logged out properly - skipping draft restore');
          localStorage.removeItem('dsr_proper_logout'); // Clear the flag
          clearDraft(); // Clean up the draft since it was completed properly
          return false;
        }
        
        const draftData = localStorage.getItem(DRAFT_KEY);
        const draftTimestamp = localStorage.getItem(DRAFT_TIMESTAMP_KEY);
        
        if (!draftData) return false;

        const formData = JSON.parse(draftData);
        const savedDate = draftTimestamp ? new Date(draftTimestamp) : null;
        
        // Check if draft has substantial data (at least 3 important fields filled)
        const importantFields = [
          'reportDate', 'projectCode', 'projectName', 'clientName', 'plantLocation',
          'onSiteTimeIn', 'onSiteTimeOut', 'workObjective', 'description', 'outcome'
        ];
        
        const filledImportantFields = importantFields.filter(field => {
          const value = formData[field];
          return value && String(value).trim().length > 0;
        }).length;
        
        // Only show draft restore if user filled minimum important fields
        if (filledImportantFields < MIN_IMPORTANT_FIELDS_FOR_DRAFT) {
          console.log(`Draft has only ${filledImportantFields} important fields (need ${MIN_IMPORTANT_FIELDS_FOR_DRAFT}) - not substantial enough to restore`);
          clearDraft(); // Clean up trivial draft
          return false;
        }
        
        console.log(`Draft has ${filledImportantFields} important fields filled - showing restore modal`);
        
        // Show custom modal to user (only if logout was NOT proper AND has substantial data)
        showDraftRestoreModal(formData, savedDate);

        return true;
      } catch (e) {
        console.error('Error loading draft:', e);
        return false;
      }
    }

    function showDraftRestoreModal(formData, savedDate) {
      const modal = document.getElementById('draftRestoreModal');
      const timestampEl = document.getElementById('draftTimestamp');
      
      if (!modal || !timestampEl) return;

      // Format the timestamp
      const dateStr = savedDate ? savedDate.toLocaleDateString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric' 
      }) : 'Unknown date';
      
      const timeStr = savedDate ? savedDate.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
      }) : 'Unknown time';

      timestampEl.innerHTML = `<strong>Last saved:</strong><span>${dateStr} at ${timeStr}</span>`;

      // Store formData temporarily for restore function
      window._draftFormData = formData;

      // Show modal
      modal.classList.add('show');
    }

    function restoreDraft() {
      const formData = window._draftFormData;
      if (!formData) return;

      try {
        // Restore form data
        if (formData.reportDate) document.getElementById('reportDate').value = formData.reportDate;
        if (formData.projectPhase) document.getElementById('projectPhase').value = formData.projectPhase;
        if (formData.projectPhaseCustom && formData.projectPhaseCustomVisible) {
          document.getElementById('projectPhaseCustom').value = formData.projectPhaseCustom;
          document.getElementById('projectPhaseCustom').style.display = 'block';
          document.getElementById('projectPhase').style.display = 'none';
        }
        if (formData.engineerNumber) document.getElementById('engineerNumber').value = formData.engineerNumber;
        if (formData.engineerName) document.getElementById('engineerName').value = formData.engineerName;
        if (formData.projectCode) document.getElementById('projectCode').value = formData.projectCode;
        if (formData.projectCodeCustom && formData.projectCodeCustomVisible) {
          document.getElementById('projectCodeCustom').value = formData.projectCodeCustom;
          document.getElementById('projectCodeCustom').style.display = 'block';
          document.getElementById('projectCode').style.display = 'none';
        }
        if (formData.projectName) document.getElementById('projectName').value = formData.projectName;
        if (formData.clientName) document.getElementById('clientName').value = formData.clientName;
        if (formData.plantLocation) document.getElementById('plantLocation').value = formData.plantLocation;
        // Convert 12-hour format to 24-hour format for time inputs
        function convert12To24(time12) {
          if (!time12 || time12 === 'N/A') return '';
          // If already in 24-hour format (no AM/PM), return as is
          if (!time12.toUpperCase().includes('AM') && !time12.toUpperCase().includes('PM')) {
            return time12;
          }
          try {
            const timeUpper = time12.toUpperCase().trim();
            const isPM = timeUpper.includes('PM');
            const timeStr = timeUpper.replace(/AM|PM/g, '').trim();
            const [hour, minute] = timeStr.split(':');
            let hour24 = parseInt(hour, 10);
            if (hour24 === 12) {
              hour24 = isPM ? 12 : 0;
            } else if (isPM) {
              hour24 += 12;
            }
            return `${hour24.toString().padStart(2, '0')}:${minute}`;
          } catch (e) {
            return time12;
          }
        }
        
        if (formData.travelTimeToSite) document.getElementById('travelTimeToSite').value = convert12To24(formData.travelTimeToSite);
        if (formData.travelTimeFromSite) document.getElementById('travelTimeFromSite').value = convert12To24(formData.travelTimeFromSite);
        if (formData.onSiteTimeIn) document.getElementById('onSiteTimeIn').value = convert12To24(formData.onSiteTimeIn);
        if (formData.onSiteTimeOut) document.getElementById('onSiteTimeOut').value = convert12To24(formData.onSiteTimeOut);
        if (formData.homeTravelStart) document.getElementById('homeTravelStart').value = convert12To24(formData.homeTravelStart);
        if (formData.homeTravelEnd) document.getElementById('homeTravelEnd').value = convert12To24(formData.homeTravelEnd);
        if (formData.workObjective) document.getElementById('workObjective').value = formData.workObjective;
        if (formData.description) document.getElementById('description').value = formData.description;
        if (formData.outcome) document.getElementById('outcome').value = formData.outcome;

        // Clear proper logout flag to re-enable draft protection for restored form
        localStorage.removeItem('dsr_proper_logout');
        
        // Close modal
        closeDraftRestoreModal();

        // Draft restored successfully (no toast needed)

        // Clean up
        delete window._draftFormData;
      } catch (e) {
        console.error('Error restoring draft:', e);
        alert('Failed to restore draft. Please try again.');
      }
    }

    function discardDraft() {
      clearDraft();
      localStorage.setItem('dsr_proper_logout', 'true'); // Mark as intentional discard
      closeDraftRestoreModal();
      
      // Draft discarded (no toast needed)

      // Clean up
      delete window._draftFormData;
    }

    function closeDraftRestoreModal() {
      const modal = document.getElementById('draftRestoreModal');
      if (modal) modal.classList.remove('show');
    }

    function clearDraft() {
      try {
        localStorage.removeItem(DRAFT_KEY);
        localStorage.removeItem(DRAFT_TIMESTAMP_KEY);
        console.log('Draft cleared');
      } catch (e) {
        console.error('Error clearing draft:', e);
      }
    };

    function enableAutoSave() {
      const form = document.getElementById('dsrForm');
      if (!form) return;

      function queueAutoSave(delay) {
        const timeout = typeof delay === 'number' ? delay : AUTO_SAVE_DEBOUNCE_MS;
        if (autoSaveTimer) clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(saveDraft, timeout);
      }

      window.queueDsrAutoSave = queueAutoSave;

      // Save draft on input changes (debounced)
      form.addEventListener('input', () => {
        queueAutoSave(AUTO_SAVE_DEBOUNCE_MS);
      });

      // Save draft on change events (for dropdowns and date pickers)
      form.addEventListener('change', () => {
        queueAutoSave(AUTO_SAVE_QUICK_DEBOUNCE_MS);
      });

      // PROTECTION 1: Save draft before page unload (tab close, refresh, navigate away)
      window.addEventListener('beforeunload', (e) => {
        saveDraft();
        // Note: We don't show a custom message as it's not reliable in modern browsers
      });

      // PROTECTION 2: Save draft when tab loses focus or becomes hidden
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          saveDraft();
          console.log('Draft saved - tab hidden');
        }
      });

      // PROTECTION 3: Save draft when window loses focus
      window.addEventListener('blur', () => {
        saveDraft();
        console.log('Draft saved - window blur');
      });

      // PROTECTION 4: Periodic auto-save (backup for connection loss)
      setInterval(() => {
        saveDraft();
      }, AUTO_SAVE_INTERVAL_MS);

      // PROTECTION 5: Save draft when page is about to be frozen (mobile/background tabs)
      if ('onfreeze' in document) {
        document.addEventListener('freeze', () => {
          saveDraft();
          console.log('Draft saved - page freeze');
        });
      }

      // PROTECTION 6: Save draft on page hide (more reliable than beforeunload)
      window.addEventListener('pagehide', () => {
        saveDraft();
        console.log('Draft saved - page hide');
      });

      // PROTECTION 7: Handle browser crashes via Service Worker (if available)
      if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        // Notify service worker about draft data periodically
        setInterval(() => {
          const draftData = localStorage.getItem(DRAFT_KEY);
          if (draftData) {
            navigator.serviceWorker.controller.postMessage({
              type: 'CACHE_DRAFT',
              data: draftData
            });
          }
        }, SERVICE_WORKER_CACHE_INTERVAL_MS);
      }

      console.log('Auto-save enabled with 7 protection layers');
      
      // Show protection active badge
      showProtectionBadge();
    }

    function showProtectionBadge() {
      const userInfo = document.querySelector('.user-info');
      if (!userInfo || document.getElementById('protectionBadge')) return;
      
      const badge = document.createElement('span');
      badge.id = 'protectionBadge';
      badge.className = 'protection-badge';
      badge.title = '7-layer auto-save protection active:\n• Tab close\n• Browser crash\n• Page refresh\n• Connection loss\n• Computer restart\n• Background tab\n• Window blur';
      badge.innerHTML = '<span class="dot"></span>';
      userInfo.appendChild(badge);
      
      // Monitor connection status
      monitorConnectionStatus();
    }

    function monitorConnectionStatus() {
      function updateConnectionStatus() {
        const badge = document.getElementById('protectionBadge');
        
        if (!navigator.onLine) {
          // Offline - show warning but reassure data is safe
          if (badge) {
            badge.style.background = '#f59e0b';
            badge.innerHTML = '<span class="dot"></span>Offline (Saving Locally)';
          }
          console.log('Connection lost - drafts will continue saving to localStorage');
        } else {
          // Online - restore normal status
          if (badge) {
            badge.style.background = '#10b981';
            badge.innerHTML = '<span class="dot"></span>';
          }
          console.log('Connection active - full protection enabled');
        }
      }

      // Initial check
      updateConnectionStatus();

      // Listen for connection changes
      window.addEventListener('online', updateConnectionStatus);
      window.addEventListener('offline', updateConnectionStatus);

      // Also save immediately when connection is restored
      window.addEventListener('online', () => {
        saveDraft();
        console.log('Connection restored - draft saved');
      });
    }

    let API_BASE = '';
    let HEALTH_PATH = '/health';
    let SUBMIT_PATH = '/submit_report';
    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    function getStoredConfig() {
      try { const j = localStorage.getItem('dsr_api_config'); return j ? JSON.parse(j) : null; } catch (e) { return null; }
    }
    function setStoredConfig(cfg) {
      try { localStorage.setItem('dsr_api_config', JSON.stringify(cfg)); } catch (e) {}
    }
    function getStoredApi() {
      const cfg = getStoredConfig();
      if (cfg && typeof cfg.base === 'string') return cfg.base;
      try { return localStorage.getItem('dsr_api_base') || ''; } catch (e) { return ''; }
    }
    function setStoredApi(url) {
      const cfg = getStoredConfig() || {};
      cfg.base = url;
      setStoredConfig(cfg);
      try { if (url) localStorage.setItem('dsr_api_base', url); } catch (e) {}
    }
    async function isHealthy(base, healthPath) {
      try {
        const r = await fetch(base + (healthPath || '/health'), { cache: 'no-store' });
        return r.ok;
      } catch (_) { return false; }
    }
    async function resolveApiBase() {
      // Fast path: Use cached API base if available, skip health checks
      const stored = getStoredConfig();
      const fromStore = getStoredApi();
      const qp = getQueryParam('api');
      const isHttpLike = (location.protocol === 'http:' || location.protocol === 'https:');
      
      let candidate = qp || fromStore || (isHttpLike ? '' : 'http://127.0.0.1:5000');
      SUBMIT_PATH = '/submit_report';
      
      if (qp) {
        setStoredConfig({ base: candidate, submitPath: SUBMIT_PATH });
      }
      
      // Skip health check for faster loading - assume backend is available
      API_BASE = candidate || 'http://127.0.0.1:5000';
      return API_BASE;
    }
    // If opened from file://, try redirecting to the running backend to avoid CORS issues
    if (location.protocol === 'file:') {
      fetch('http://127.0.0.1:5000/health')
        .then((r) => { if (r.ok) location.replace('http://127.0.0.1:5000/'); })
        .catch(() => {});
    }

    // Validation helper functions
    function clearValidationErrors() {
      // Remove error class from all inputs, selects, and textareas
      const form = document.getElementById('dsrForm');
      if (!form) return;
      
      const allFields = form.querySelectorAll('input, select, textarea');
      allFields.forEach(field => {
        field.classList.remove('error');
        // Remove error message if it exists
        const errorMsg = field.parentElement.querySelector('.error-message');
        if (errorMsg) {
          errorMsg.remove();
        }
      });
    }

    function highlightEmptyFields(emptyFieldKeys, projectCodeSelectEl, projectCodeCustomEl, projectPhaseSelectEl, projectPhaseCustomEl) {
      emptyFieldKeys.forEach(key => {
        let fieldElement = null;
        
        // Special handling for project code and project phase
        if (key === 'projectCode') {
          if (projectCodeCustomEl && projectCodeCustomEl.style.display !== 'none') {
            fieldElement = projectCodeCustomEl;
          } else if (projectCodeSelectEl) {
            fieldElement = projectCodeSelectEl;
          }
        } else if (key === 'projectPhase') {
          if (projectPhaseCustomEl && projectPhaseCustomEl.style.display !== 'none') {
            fieldElement = projectPhaseCustomEl;
          } else if (projectPhaseSelectEl) {
            fieldElement = projectPhaseSelectEl;
          }
        } else if (key === 'projectName' || key === 'clientName' || key === 'plantLocation') {
          // Check if select is visible, otherwise use input
          const selectEl = document.getElementById(key + 'Select');
          const inputEl = document.getElementById(key);
          if (selectEl && selectEl.style.display !== 'none') {
            fieldElement = selectEl;
          } else if (inputEl) {
            fieldElement = inputEl;
          }
        } else {
          // Standard field
          fieldElement = document.getElementById(key);
        }
        
        if (fieldElement) {
          fieldElement.classList.add('error');
          
          // Add error message below the field
          const errorMsg = fieldElement.parentElement.querySelector('.error-message');
          if (!errorMsg) {
            const errorElement = document.createElement('span');
            errorElement.className = 'error-message';
            errorElement.textContent = 'This field is required';
            fieldElement.parentElement.appendChild(errorElement);
          }
        }
      });
    }

    function scrollToFirstEmptyField(firstEmptyKey, projectCodeSelectEl, projectCodeCustomEl, projectPhaseSelectEl, projectPhaseCustomEl) {
      let targetElement = null;
      
      // Special handling for project code and project phase
      if (firstEmptyKey === 'projectCode') {
        if (projectCodeCustomEl && projectCodeCustomEl.style.display !== 'none') {
          targetElement = projectCodeCustomEl;
        } else if (projectCodeSelectEl) {
          targetElement = projectCodeSelectEl;
        }
      } else if (firstEmptyKey === 'projectPhase') {
        if (projectPhaseCustomEl && projectPhaseCustomEl.style.display !== 'none') {
          targetElement = projectPhaseCustomEl;
        } else if (projectPhaseSelectEl) {
          targetElement = projectPhaseSelectEl;
        }
      } else if (firstEmptyKey === 'projectName' || firstEmptyKey === 'clientName' || firstEmptyKey === 'plantLocation') {
        // Check if select is visible, otherwise use input
        const selectEl = document.getElementById(firstEmptyKey + 'Select');
        const inputEl = document.getElementById(firstEmptyKey);
        if (selectEl && selectEl.style.display !== 'none') {
          targetElement = selectEl;
        } else if (inputEl) {
          targetElement = inputEl;
        }
      } else {
        targetElement = document.getElementById(firstEmptyKey);
      }
      
      if (targetElement) {
        // Scroll to the first empty field with smooth behavior
        // Using 'nearest' block to show as much context as possible
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
        // Focus and highlight the element after scroll completes
        setTimeout(() => {
          targetElement.focus();
          // Highlight with a shake animation to draw attention
          targetElement.style.animation = 'shake 0.5s ease-in-out';
          // Remove animation after it completes so it can be triggered again
          setTimeout(() => {
            targetElement.style.animation = '';
          }, 500);
        }, 300);
      }
    }

    // Clear validation errors when user fills in fields
    function setupValidationClear() {
      const form = document.getElementById('dsrForm');
      if (!form) return;
      
      function isFieldFilled(field) {
        if (!field) return false;
        
        // Check if field has a value
        const value = field.value ? field.value.trim() : '';
        
        // For select elements, check if it's not the placeholder option
        if (field.tagName === 'SELECT') {
          const selectedOption = field.options[field.selectedIndex];
          // If option is disabled or value is empty, it's not filled
          if (selectedOption && (selectedOption.disabled || selectedOption.value === '')) {
            return false;
          }
          // If "None" is selected, the select itself is considered filled (custom field is separate)
          // The custom field will be validated separately
          if (value === 'None') {
            return true; // Select is filled, but custom field needs to be checked separately
          }
          return value !== '';
        }
        
        // For text inputs, date, time, textarea - just check if value exists
        return value !== '';
      }
      
      function clearFieldError(field) {
        if (!field) return;
        
        // Only clear error if field is actually filled
        if (field.classList.contains('error') && isFieldFilled(field)) {
          field.classList.remove('error');
          const errorMsg = field.parentElement.querySelector('.error-message');
          if (errorMsg) {
            errorMsg.remove();
          }
          
          // Also clear error from related custom field if it exists
          if (field.id === 'projectCode' || field.id === 'projectPhase') {
            const customId = field.id + 'Custom';
            const customField = document.getElementById(customId);
            if (customField && customField.classList.contains('error') && isFieldFilled(customField)) {
              customField.classList.remove('error');
              const customErrorMsg = customField.parentElement.querySelector('.error-message');
              if (customErrorMsg) {
                customErrorMsg.remove();
              }
            }
          }
        }
      }
      
      // Clear error on input (as user types)
      form.addEventListener('input', function(e) {
        clearFieldError(e.target);
      });
      
      // Clear error on change (for selects, date pickers, etc.)
      form.addEventListener('change', function(e) {
        clearFieldError(e.target);
        
        // Special handling for project code and project phase
        if (e.target.id === 'projectCode' || e.target.id === 'projectPhase') {
          // Clear error from select if it has a valid selection
          clearFieldError(e.target);
          
          // If "None" is selected, focus on custom field
          if (e.target.value === 'None') {
            const customId = e.target.id + 'Custom';
            const customField = document.getElementById(customId);
            if (customField) {
              setTimeout(() => {
                if (customField.style.display !== 'none') {
                  customField.focus();
                  // If custom field has error and is empty, it will remain highlighted
                  // User needs to fill it to clear the error
                }
              }, 100);
            }
          }
        }
      });
      
      // Handle custom fields for project code and project phase
      const projectCodeCustom = document.getElementById('projectCodeCustom');
      const projectPhaseCustom = document.getElementById('projectPhaseCustom');
      
      if (projectCodeCustom) {
        projectCodeCustom.addEventListener('input', function() {
          clearFieldError(this);
          // Also clear error from the select if custom is filled
          const selectField = document.getElementById('projectCode');
          if (selectField && this.value && this.value.trim() !== '') {
            clearFieldError(selectField);
          }
        });
      }
      
      if (projectPhaseCustom) {
        projectPhaseCustom.addEventListener('input', function() {
          clearFieldError(this);
          // Also clear error from the select if custom is filled
          const selectField = document.getElementById('projectPhase');
          if (selectField && this.value && this.value.trim() !== '') {
            clearFieldError(selectField);
          }
        });
      }
      
      // Handle Site Inspection mode fields (projectNameSelect, clientNameSelect, plantLocationSelect)
      // These can be either selects or inputs depending on mode
      const siteInspectionFields = ['projectName', 'clientName', 'plantLocation'];
      siteInspectionFields.forEach(fieldName => {
        const inputField = document.getElementById(fieldName);
        const selectField = document.getElementById(fieldName + 'Select');
        
        if (inputField) {
          inputField.addEventListener('input', function() {
            clearFieldError(this);
            // If select version exists and is visible, also clear its error
            if (selectField && selectField.style.display !== 'none') {
              // Sync value to select if needed
              if (this.value && this.value.trim() !== '') {
                clearFieldError(selectField);
              }
            }
          });
        }
        
        if (selectField) {
          selectField.addEventListener('change', function() {
            clearFieldError(this);
            // If input version exists, also clear its error
            if (inputField && this.value && this.value.trim() !== '') {
              clearFieldError(inputField);
            }
          });
        }
      });
    }
    

    async function submitForm(event) {
      event.preventDefault();

      // Disable submit button immediately to prevent double submission
      const submitBtn = document.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn ? submitBtn.textContent : '';
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      // Get form values with null checks
      const getFieldValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : '';
      };

      // Helper function to get value from either input or select (for Site Inspection mode)
      const getFieldValueOrSelect = (inputId, selectId) => {
        const inputEl = document.getElementById(inputId);
        const selectEl = document.getElementById(selectId);
        // If select is visible and has a valid value (not empty, not placeholder), use it
        if (selectEl && selectEl.style.display !== 'none' && selectEl.value && selectEl.value.trim() !== '') {
          // Check if it's a placeholder option (disabled or empty value)
          const selectedOption = selectEl.options[selectEl.selectedIndex];
          if (selectedOption && !selectedOption.disabled && selectedOption.value !== '') {
            return selectEl.value.trim();
          }
        }
        // Otherwise use input if it exists and has value
        if (inputEl && inputEl.value && inputEl.value.trim() !== '') {
          return inputEl.value.trim();
        }
        return '';
      };

      // Get project code from either dropdown or custom input
      const projectCodeSelectEl = document.getElementById('projectCode');
      const projectCodeCustomEl = document.getElementById('projectCodeCustom');
      let projectCodeValue = '';
      // Check if custom input is visible and has a value
      if (projectCodeCustomEl && projectCodeCustomEl.style.display !== 'none') {
        if (projectCodeCustomEl.value && projectCodeCustomEl.value.trim() !== '') {
          projectCodeValue = projectCodeCustomEl.value.trim();
        }
        // If custom is visible but empty, projectCodeValue remains empty (will be caught by validation)
      } else if (projectCodeSelectEl) {
        // Custom is not visible, check select
        const selectedValue = projectCodeSelectEl.value ? projectCodeSelectEl.value.trim() : '';
        // Include "None" as a valid value
        if (selectedValue !== '' && selectedValue !== 'Select Project Code') {
          projectCodeValue = selectedValue;
        }
        // If value is empty or placeholder, projectCodeValue remains empty
      }

      // Get project phase from either dropdown or custom input
      const projectPhaseSelectEl = document.getElementById('projectPhase');
      const projectPhaseCustomEl = document.getElementById('projectPhaseCustom');
      let projectPhaseValue = '';
      // Check if custom input is visible and has a value
      if (projectPhaseCustomEl && projectPhaseCustomEl.style.display !== 'none') {
        if (projectPhaseCustomEl.value && projectPhaseCustomEl.value.trim() !== '') {
          projectPhaseValue = projectPhaseCustomEl.value.trim();
        }
        // If custom is visible but empty, projectPhaseValue remains empty (will be caught by validation)
      } else if (projectPhaseSelectEl) {
        // Custom is not visible, check select
        const selectedValue = projectPhaseSelectEl.value ? projectPhaseSelectEl.value.trim() : '';
        // Include "None" as a valid value
        if (selectedValue !== '' && selectedValue !== 'Select Project Phase') {
          projectPhaseValue = selectedValue;
        }
        // If value is empty or placeholder, projectPhaseValue remains empty
      }

      // Get project name, client name, and plant location (could be from input or select)
      const projectNameValue = getFieldValueOrSelect('projectName', 'projectNameSelect');
      const clientNameValue = getFieldValueOrSelect('clientName', 'clientNameSelect');
      const plantLocationValue = getFieldValueOrSelect('plantLocation', 'plantLocationSelect');

      // Collect all field values for validation
      const fieldValues = {
        reportDate: getFieldValue('reportDate').trim(),
        projectPhase: projectPhaseValue,
        engineerName: getFieldValue('engineerName').trim(),
        projectName: projectNameValue,
        projectCode: projectCodeValue,
        clientName: clientNameValue,
        plantLocation: plantLocationValue,
        travelTimeToSite: getFieldValue('travelTimeToSite').trim(),
        travelTimeFromSite: getFieldValue('travelTimeFromSite').trim(),
        onSiteTimeIn: getFieldValue('onSiteTimeIn').trim(),
        onSiteTimeOut: getFieldValue('onSiteTimeOut').trim(),
        homeTravelStart: getFieldValue('homeTravelStart').trim(),
        homeTravelEnd: getFieldValue('homeTravelEnd').trim(),
        workObjective: getFieldValue('workObjective').trim(),
        description: getFieldValue('description').trim(),
        outcome: getFieldValue('outcome').trim(),
      };

      // Field labels for error messages
      const fieldLabels = {
        reportDate: 'Report Date',
        projectPhase: 'Project Phase',
        engineerName: 'Engineer Name',
        projectName: 'Project Name',
        projectCode: 'Project Code',
        clientName: 'Client Name',
        plantLocation: 'Plant Location',
        travelTimeToSite: 'Travel Time To Site (Start)',
        travelTimeFromSite: 'Travel Time From Site (End)',
        onSiteTimeIn: 'On-Site Time In',
        onSiteTimeOut: 'On-Site Time Out',
        homeTravelStart: 'Home Travel Start',
        homeTravelEnd: 'Home Travel End',
        workObjective: 'Work Objective',
        description: 'Description',
        outcome: 'Outcome',
      };

      // Clear previous validation errors
      clearValidationErrors();

      // Validate all fields are filled
      const emptyFieldKeys = [];
      for (const [key, value] of Object.entries(fieldValues)) {
        if (!value || value === '') {
          emptyFieldKeys.push(key);
        }
      }

      // If any field is empty, highlight errors and prevent submission
      if (emptyFieldKeys.length > 0) {
        // Highlight all empty fields
        highlightEmptyFields(emptyFieldKeys, projectCodeSelectEl, projectCodeCustomEl, projectPhaseSelectEl, projectPhaseCustomEl);
        
        // Scroll to first empty field
        scrollToFirstEmptyField(emptyFieldKeys[0], projectCodeSelectEl, projectCodeCustomEl, projectPhaseSelectEl, projectPhaseCustomEl);
        
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }
        return; // Stop submission
      }

      const payload = {
        reportDate: fieldValues.reportDate,
        projectPhase: fieldValues.projectPhase,
        engineerName: fieldValues.engineerName,
        projectName: fieldValues.projectName,
        projectCode: fieldValues.projectCode,
        clientName: fieldValues.clientName,
        plantLocation: fieldValues.plantLocation,
        travelTimeToSite: fieldValues.travelTimeToSite,
        travelTimeFromSite: fieldValues.travelTimeFromSite,
        onSiteTimeIn: fieldValues.onSiteTimeIn,
        onSiteTimeOut: fieldValues.onSiteTimeOut,
        onSiteDuration: getFieldValue('onSiteDuration'),
        homeTravelStart: fieldValues.homeTravelStart,
        homeTravelEnd: fieldValues.homeTravelEnd,
        homeTravelDuration: getFieldValue('homeTravelDuration'),
        workObjective: fieldValues.workObjective,
        description: fieldValues.description,
        outcome: fieldValues.outcome,
      };

      try {
        // Fast path: Get API base immediately without async resolution if possible
        let apiBaseUrl = '';
        if (window.DSRAuth && typeof window.DSRAuth.getApiBase === 'function') {
          apiBaseUrl = window.DSRAuth.getApiBase();
        }
        if (!apiBaseUrl || apiBaseUrl === '' || apiBaseUrl === '.') {
          // Use cached API_BASE if available, otherwise resolve
          if (typeof API_BASE !== 'undefined' && API_BASE) {
            apiBaseUrl = API_BASE;
          } else {
            await resolveApiBase();
            apiBaseUrl = API_BASE || 'http://127.0.0.1:5000';
          }
        }
        
        // Ensure no trailing slash
        apiBaseUrl = apiBaseUrl.replace(/\/$/, '');
        const submitUrl = apiBaseUrl + SUBMIT_PATH;
        
        // Prepare headers and token in parallel
        const token = (window.DSRAuth && typeof window.DSRAuth.getToken === 'function' && window.DSRAuth.getToken()) || localStorage.getItem('dsr_jwt_token');
        const headers = { 
          'Content-Type': 'application/json', 
          'Accept': 'application/json',
          ...(token ? { 'Authorization': 'Bearer ' + token } : {})
        };
        
        // Submit immediately - no delays
        const res = await fetch(submitUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload)
        });
        
        // Fast JSON parsing
        const data = await res.json();
        
        if (!res.ok || !(data.ok || data.status === 'ok')) {
          const errorMsg = data.error || data.detail || ('HTTP ' + res.status);
          throw new Error(errorMsg);
        }
        
        // Clear draft and show success immediately (non-blocking)
        clearDraft();
        localStorage.setItem('dsr_proper_logout', 'true');
        
        // Show success modal
        const successOverlay = document.getElementById('successOverlay');
        if (successOverlay) {
          successOverlay.classList.remove('hidden');
        }
      } catch (err) {
        const errorMessage = (err && err.message ? err.message : String(err));
        alert('Error: ' + errorMessage);
        
        // If auth error, suggest relogin
        if (errorMessage.includes('Authentication') || errorMessage.includes('login')) {
          setTimeout(() => {
            if (confirm('Authentication required. Would you like to go to the login page?')) {
              window.location.href = 'login.html';
            }
          }, 1000);
        }
      } finally {
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
        }
      }
    }

    

    // Map engineer codes to their names
    const codeToEngineerName = {
      'EN001': 'JKC',
      'EN002': 'RRM',
      'EN003': 'VRG',
      'EN004': 'JRM',
      'EN005': 'RRP',
      'EN007': 'RDB',
      'EN008': 'ASO',
      'EN009': 'AMM',
      'EN010': 'MLL',
      'EN011': 'PHC'
    };

    // Map engineer codes to their initials (used in history view display)
    const engineerCodeToInitials = {
      'EN001': 'JKC',
      'EN002': 'RRM',
      'EN003': 'VRG',
      'EN004': 'JRM',
      'EN005': 'RRP',
      'EN007': 'RDB',
      'EN008': 'ASO',
      'EN009': 'AMM',
      'EN010': 'MLL',
      'EN011': 'PHC'
    };

    // Format engineer name with correct initials based on code
    function formatEngineerNameForHistory(engineerName, engineerCode) {
      if (!engineerName && !engineerCode) return 'N/A';
      
      // If we have a code, use it to get the correct initials
      if (engineerCode) {
        const code = engineerCode.toUpperCase().trim();
        const initials = engineerCodeToInitials[code];
        if (initials) {
          return `${code} - ${initials}`;
        }
        // If code not found in mapping, use code as fallback
        return `${code} - ${engineerName || code}`;
      }
      
      // If no code but we have name, try to extract code from name
      if (engineerName) {
        const normalized = engineerName.replace(/[–—]/g, '-');
        const codeMatch = normalized.match(/\bEN\d{3}\b/i);
        if (codeMatch) {
          const code = codeMatch[0].toUpperCase();
          const initials = engineerCodeToInitials[code];
          if (initials) {
            return `${code} - ${initials}`;
          }
          // Try to extract initials from name if format is "EN001 - JKC" or similar
          if (normalized.includes(' - ')) {
            const [, rest] = normalized.split(' - ', 2);
            const extractedInitials = (rest.split('(')[0] || '').trim();
            if (extractedInitials) {
              return `${code} - ${extractedInitials}`;
            }
          }
          return `${code} - ${code}`;
        }
        return normalized.trim();
      }
      
      return 'N/A';
    }

    // Map project codes to project info - will be populated from API
    let projectCodeInfo = {};

    window.addEventListener('DOMContentLoaded', async () => {
      // Auth gate: require valid JWT; otherwise send to login with return
      try {
        const hasAuth = (window.DSRAuth && typeof window.DSRAuth.isLoggedIn === 'function' && window.DSRAuth.isLoggedIn());
        if (!hasAuth) {
          if (window.DSRAuth && typeof window.DSRAuth.redirectWithReturn === 'function') {
            window.DSRAuth.redirectWithReturn('login.html');
          } else {
            const target = window.location.pathname + window.location.search + window.location.hash;
            window.location.replace('login.html?redirect=' + encodeURIComponent(target));
          }
          return;
        }
        // Clear proper logout flag when user logs in successfully
        localStorage.removeItem('dsr_proper_logout');
      } catch (e) {
        window.location.replace('login.html');
        return;
      }
      // Load and display current user info - optimized to use session data first
      try {
        const session = localStorage.getItem('dsr_session');
        let engineerData = null;
        let username = null;
        
        if (session) {
          try {
            engineerData = JSON.parse(session);
            username = engineerData.engineerCode || null;
          } catch (_) {}
        }
        
        // Only call API if session data is missing
        if (!engineerData || !username) {
          try {
            const userInfo = await window.DSRAuth.me();
            username = userInfo && userInfo.user ? userInfo.user.username : username;
          } catch (_) {}
        }
        
        // Display user info
        const userNameEl = document.getElementById('currentUserName');
        if (userNameEl) {
          if (engineerData && engineerData.engineerName && engineerData.engineerCode) {
            userNameEl.textContent = engineerData.engineerName + ' (' + engineerData.engineerCode + ')';
          } else if (username) {
            userNameEl.textContent = username;
          }
        }
        
        // Pre-fill engineer fields
        const engineerNumberInput = document.getElementById('engineerNumber');
        const engineerNameInput = document.getElementById('engineerName');
        
        if (engineerNumberInput && engineerNameInput) {
          if (engineerData && engineerData.engineerCode && engineerData.engineerName) {
            engineerNumberInput.value = engineerData.engineerCode;
            engineerNameInput.value = engineerData.engineerName;
          } else if (username) {
            engineerNumberInput.value = username;
            engineerNameInput.value = username;
          }
        }
      } catch (e) {
        // Silently handle errors
      }

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      }

      // Remove duplicate containers once on load (no continuous watching for performance)
      const containers = document.querySelectorAll('.container');
      if (containers.length > 1) {
        containers.forEach((el, idx) => { if (idx > 0) el.remove(); });
      }
      
      // Resolve API base (cached, no health check)
      resolveApiBase();

      // Load projects from API and populate dropdown
      async function loadProjectsFromAPI() {
        try {
          const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
          const apiBase = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') || '';
          const url = apiBase + '/projectdefs';
          
          const res = await fetch(url, { 
            headers,
            cache: 'no-cache',
            method: 'GET'
          });
          
          if (!res.ok) {
            throw new Error('Failed to fetch projects');
          }
          
          const data = await res.json();
          if (!data.ok || !data.items) {
            throw new Error('Invalid response from server');
          }
          
          const projects = data.items || [];
          
          // Build projectCodeInfo object from fetched projects
          projectCodeInfo = {};
          projects.forEach(project => {
            if (project.code) {
              projectCodeInfo[project.code] = {
                projectName: project.name || '',
                clientName: project.client || '',
                plantLocation: project.location || ''
              };
            }
          });
          
          // Sort project codes alphabetically
          const sortedCodes = Object.keys(projectCodeInfo).sort();
          
          // Populate project code dropdown
          const projectCodeSelect = document.getElementById('projectCode');
          if (projectCodeSelect) {
            // Clear existing options except the first placeholder
            projectCodeSelect.innerHTML = '<option value="" selected>Select Project Code</option>';
            
            // Add "None" and "Site Inspection" options
            const noneOption = document.createElement('option');
            noneOption.value = 'None';
            noneOption.textContent = 'None';
            projectCodeSelect.appendChild(noneOption);
            
            const siteInspectionOption = document.createElement('option');
            siteInspectionOption.value = 'Site Inspection';
            siteInspectionOption.textContent = 'Site Inspection';
            projectCodeSelect.appendChild(siteInspectionOption);
            
            // Add sorted project codes
            sortedCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code;
              option.textContent = code;
              projectCodeSelect.appendChild(option);
            });
          }
          
          console.log(`Loaded ${projects.length} projects from API`);
        } catch (e) {
          console.error('Error loading projects from API:', e);
          // Fallback: keep existing hardcoded options if API fails
          // The dropdown will still work with existing hardcoded values
        }
      }
      
      // Load projects on page load
      await loadProjectsFromAPI();

      // Engineer number is now a text input - no auto-fill functionality needed

      // Auto-fill project fields when project code is chosen
      const projectCodeSelect = document.getElementById('projectCode');
      const projectCodeCustom = document.getElementById('projectCodeCustom');
      const projectNameInput = document.getElementById('projectName');
      const clientNameInput = document.getElementById('clientName');
      const plantLocationInput = document.getElementById('plantLocation');
      // Declare phase and related selects BEFORE they are used anywhere below
      const projectPhaseSelect = document.getElementById('projectPhase');
      const projectPhaseCustom = document.getElementById('projectPhaseCustom');
      const projectNameSelect = document.getElementById('projectNameSelect');
      const clientNameSelect = document.getElementById('clientNameSelect');
      const plantLocationSelect = document.getElementById('plantLocationSelect');
      let isAnchoredByProjectCode = false; // when true, Site Inspection mode is enforced by Project Code

      function setProjectFieldsFromCode() {
        if (!projectCodeSelect || !projectNameInput || !clientNameInput || !plantLocationInput) return;
        const code = (projectCodeSelect.value || '').trim();
        
        if (code === 'None') {
          // clear anchor and re-enable phase control
          isAnchoredByProjectCode = false;
          if (projectPhaseSelect) projectPhaseSelect.disabled = false;
          // When "None" is selected, keep dropdown visible with "None"
          if (projectCodeSelect) {
            projectCodeSelect.style.display = 'block';
            projectCodeSelect.value = 'None';
          }
          // Hide custom input
          if (projectCodeCustom) {
            projectCodeCustom.style.display = 'none';
          }
          projectNameInput.value = '';
          clientNameInput.value = '';
          plantLocationInput.value = '';
        } else if (code === 'Site Inspection') {
          // Swap: Apply Site Inspection UI when selected in Project Code
          // Show selects, hide inputs
          setVisible(projectNameSelect, true);
          setVisible(clientNameSelect, true);
          setVisible(plantLocationSelect, true);
          setVisible(projectNameInput, false);
          setVisible(clientNameInput, false);
          setVisible(plantLocationInput, false);
          // Ensure dropdown code visible (hide custom)
          if (projectCodeSelect && projectCodeCustom) {
            setVisible(projectCodeSelect, true);
            setVisible(projectCodeCustom, false);
          }
          // Populate dropdowns
          populateSelect(projectNameSelect, 'Select Project Name', allProjectNames);
          populateSelect(clientNameSelect, 'Select Client Name', allClientNames);
          populateSelect(plantLocationSelect, 'Select Plant Location', allPlantLocations);
          // Preserve existing values
          if (projectNameInput && projectNameInput.value) projectNameSelect.value = projectNameInput.value;
          if (clientNameInput && clientNameInput.value) clientNameSelect.value = clientNameInput.value;
          if (plantLocationInput && plantLocationInput.value) plantLocationSelect.value = plantLocationInput.value;
        } else if (code) {
          // clear anchor and re-enable phase control
          isAnchoredByProjectCode = false;
          if (projectPhaseSelect) projectPhaseSelect.disabled = false;
          // Hide custom input if shown
          if (projectCodeCustom) {
            projectCodeSelect.style.display = 'block';
            projectCodeCustom.style.display = 'none';
          }
          // Populate with project data (users can edit after population)
          const info = projectCodeInfo[code];
          if (info) {
            projectNameInput.value = info.projectName || '';
            clientNameInput.value = info.clientName || '';
            plantLocationInput.value = info.plantLocation || '';
          }
        }
      }

      // Allow switching back to dropdown from custom input
      if (projectCodeCustom) {
        projectCodeCustom.addEventListener('blur', function() {
          if (!this.value.trim()) {
            projectCodeSelect.style.display = 'block';
            projectCodeSelect.value = '';
            this.style.display = 'none';
          }
        });
      }

      if (projectCodeSelect && projectNameInput && clientNameInput && plantLocationInput) {
        projectCodeSelect.addEventListener('change', setProjectFieldsFromCode);
        setProjectFieldsFromCode();
      }

      // Toggle dropdowns when Project Phase is "Site Inspection"

      function unique(values) {
        const seen = new Set();
        const out = [];
        for (const v of values) {
          const s = String(v || '').trim();
          if (s && !seen.has(s)) { seen.add(s); out.push(s); }
        }
        return out;
      }

      const allProjectNames = unique(Object.values(projectCodeInfo).map(v => v.projectName));
      const allClientNames = unique(Object.values(projectCodeInfo).map(v => v.clientName));
      const allPlantLocations = unique(Object.values(projectCodeInfo).map(v => v.plantLocation));

      function populateSelect(selectEl, placeholder, values) {
        if (!selectEl) return;
        while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
        const ph = document.createElement('option');
        ph.value = '';
        ph.disabled = true;
        ph.selected = true;
        ph.textContent = placeholder;
        selectEl.appendChild(ph);
        for (const val of values) {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          selectEl.appendChild(opt);
        }
      }

      function syncSelectToInput(selectEl, inputEl) {
        if (!selectEl || !inputEl) return;
        inputEl.value = selectEl.value;
      }

      function setVisible(el, visible) {
        if (!el) return;
        el.style.display = visible ? 'block' : 'none';
      }

      function handleProjectPhaseChange() {
        if (!projectPhaseSelect) return;
        const phaseValue = String(projectPhaseSelect.value).trim().toLowerCase();
        const isSiteInspection = phaseValue === 'site inspection';
        const isNone = phaseValue === 'none';

        // When "None" is selected, show custom text input
        if (isNone && projectPhaseCustom) {
          projectPhaseSelect.style.display = 'none';
          projectPhaseCustom.style.display = 'block';
          projectPhaseCustom.focus();
          
          // Check if project code is already selected (either via dropdown or custom input)
          const hasProjectCodeSelect = projectCodeSelect && projectCodeSelect.value && projectCodeSelect.value.trim() !== '' && projectCodeSelect.value !== 'None' && projectCodeSelect.value !== 'Site Inspection';
          const hasProjectCodeCustom = projectCodeCustom && projectCodeCustom.value && projectCodeCustom.value.trim() !== '';
          const hasProjectCode = hasProjectCodeSelect || hasProjectCodeCustom;
          
          // Clear project-related fields when None is selected, but preserve project code and related fields if project code is set
          // Do NOT affect project code - it should remain independent
          if (projectNameInput && !hasProjectCode) projectNameInput.value = '';
          // Only clear client name and plant location if project code is not set
          if (clientNameInput && !hasProjectCode) clientNameInput.value = '';
          if (plantLocationInput && !hasProjectCode) plantLocationInput.value = '';
          if (projectNameSelect && !hasProjectCode) projectNameSelect.value = '';
          if (clientNameSelect && !hasProjectCode) clientNameSelect.value = '';
          if (plantLocationSelect && !hasProjectCode) plantLocationSelect.value = '';
        } else {
          // For other selections, ensure dropdown is visible
          if (projectPhaseCustom && projectPhaseSelect) {
            projectPhaseSelect.style.display = 'block';
            projectPhaseCustom.style.display = 'none';
          }
        }
      }

      // Dropdown handlers - sync to hidden input and auto-fill related fields
      if (projectNameSelect) {
        projectNameSelect.addEventListener('change', () => {
          syncSelectToInput(projectNameSelect, projectNameInput);
          // Auto-fill client name and plant location when project name is selected (but not project code)
          const selectedProjectName = projectNameSelect.value;
          
          if (!selectedProjectName || selectedProjectName === 'Select Project Name') {
            // Re-enable dropdowns if project name is cleared
            if (clientNameSelect) clientNameSelect.disabled = false;
            if (plantLocationSelect) plantLocationSelect.disabled = false;
          } else {
            const entries = Object.entries(projectCodeInfo);
            for (const [code, info] of entries) {
              if (String(info.projectName || '').trim() === String(selectedProjectName || '').trim()) {
                // Update both inputs and selects with matching data
                if (clientNameInput) clientNameInput.value = info.clientName || '';
                if (plantLocationInput) plantLocationInput.value = info.plantLocation || '';
                if (clientNameSelect) {
                  clientNameSelect.value = info.clientName || '';
                  clientNameSelect.disabled = true; // Disable since it's auto-populated
                }
                if (plantLocationSelect) {
                  plantLocationSelect.value = info.plantLocation || '';
                  plantLocationSelect.disabled = true; // Disable since it's auto-populated
                }
                break;
              }
            }
          }
        });
      }
      if (clientNameSelect) {
        clientNameSelect.addEventListener('change', () => {
          syncSelectToInput(clientNameSelect, clientNameInput);
          // Auto-fill project name and plant location when client name is selected (but not project code)
          const selectedClientName = clientNameSelect.value;
          const entries = Object.entries(projectCodeInfo);
          for (const [code, info] of entries) {
            if (String(info.clientName || '').trim() === String(selectedClientName || '').trim()) {
              // Update both inputs and selects with matching data
              if (projectNameInput) projectNameInput.value = info.projectName || '';
              if (plantLocationInput) plantLocationInput.value = info.plantLocation || '';
              if (projectNameSelect) projectNameSelect.value = info.projectName || '';
              if (plantLocationSelect) plantLocationSelect.value = info.plantLocation || '';
              break;
            }
          }
        });
      }
      if (plantLocationSelect) {
        plantLocationSelect.addEventListener('change', () => {
          syncSelectToInput(plantLocationSelect, plantLocationInput);
          // Auto-fill project name and client name when plant location is selected (but not project code)
          const selectedPlantLocation = plantLocationSelect.value;
          const entries = Object.entries(projectCodeInfo);
          for (const [code, info] of entries) {
            if (String(info.plantLocation || '').trim() === String(selectedPlantLocation || '').trim()) {
              // Update both inputs and selects with matching data
              if (projectNameInput) projectNameInput.value = info.projectName || '';
              if (clientNameInput) clientNameInput.value = info.clientName || '';
              if (projectNameSelect) projectNameSelect.value = info.projectName || '';
              if (clientNameSelect) clientNameSelect.value = info.clientName || '';
              break;
            }
          }
        });
      }

      if (projectCodeSelect) {
        projectCodeSelect.addEventListener('change', function () {
          const code = (projectCodeSelect.value || '').trim();
          
          // Get project code custom input element
          const projectCodeCustom = document.getElementById('projectCodeCustom');
          
          // When "None" is selected, ensure dropdown is visible with "None"
          if (code === 'None') {
            // Ensure dropdown is visible and "None" is selected
            if (projectCodeSelect) {
              projectCodeSelect.style.display = 'block';
              projectCodeSelect.value = 'None';
            }
            // Hide custom input if it exists
            if (projectCodeCustom) {
              projectCodeCustom.style.display = 'none';
            }
          }
          
          if (code === 'Site Inspection') {
            // Apply Site Inspection UI via Project Code
            setVisible(projectNameSelect, true);
            setVisible(clientNameSelect, true);
            setVisible(plantLocationSelect, true);
            setVisible(projectNameInput, false);
            setVisible(clientNameInput, false);
            setVisible(plantLocationInput, false);
            populateSelect(projectNameSelect, 'Select Project Name', allProjectNames);
            populateSelect(clientNameSelect, 'Select Client Name', allClientNames);
            populateSelect(plantLocationSelect, 'Select Plant Location', allPlantLocations);
            if (projectNameInput && projectNameInput.value) projectNameSelect.value = projectNameInput.value;
            if (clientNameInput && clientNameInput.value) clientNameSelect.value = clientNameInput.value;
            if (plantLocationInput && plantLocationInput.value) plantLocationSelect.value = plantLocationInput.value;
          } else {
            // Normal mode: hide selects, show inputs
            setVisible(projectNameSelect, false);
            setVisible(clientNameSelect, false);
            setVisible(plantLocationSelect, false);
            setVisible(projectNameInput, true);
            setVisible(clientNameInput, true);
            setVisible(plantLocationInput, true);
            if (code) {
              const info = projectCodeInfo[code];
              if (info) {
                if (projectNameInput) projectNameInput.value = info.projectName || '';
                if (clientNameInput) projectNameInput && (clientNameInput.value = info.clientName || '');
                if (plantLocationInput) plantLocationInput.value = info.plantLocation || '';
              }
            }
          }
        });
      }

      if (projectPhaseSelect) {
        projectPhaseSelect.addEventListener('change', handleProjectPhaseChange);
        handleProjectPhaseChange();
      }

      // Allow switching back to dropdown from custom input
      if (projectPhaseCustom) {
        projectPhaseCustom.addEventListener('blur', function() {
          if (!this.value.trim()) {
            projectPhaseSelect.style.display = 'block';
            projectPhaseSelect.value = '';
            this.style.display = 'none';
          }
        });
      }

      // Compute durations HH:MM (handles overnight)
      const timeInInput = document.getElementById('onSiteTimeIn');
      const timeOutInput = document.getElementById('onSiteTimeOut');
      const durationOutput = document.getElementById('onSiteDuration');
      const travelStartInput = document.getElementById('travelTimeToSite');
      const travelEndInput = document.getElementById('travelTimeFromSite');
      const travelDurationOutput = document.getElementById('travelDuration');

      function toMinutes(hhmm) {
        const [h, m] = String(hhmm || '').split(':').map(Number);
        if (Number.isNaN(h) || Number.isNaN(m)) return null;
        return h * 60 + m;
      }

      function formatMinutes(total) {
        const h = Math.floor(total / 60);
        const m = total % 60;
        const hLabel = h === 1 ? 'hour' : 'hours';
        const mLabel = m === 1 ? 'minute' : 'minutes';
        return String(h) + ' ' + hLabel + ' ' + String(m).padStart(2, '0') + ' ' + mLabel;
      }

      function updateDuration() {
        try {
          if (!timeInInput || !timeOutInput || !durationOutput) return;
          const minIn = toMinutes(timeInInput.value);
          const minOut = toMinutes(timeOutInput.value);
          if (minIn == null || minOut == null) {
            durationOutput.value = '';
            return;
          }
          let diff = minOut - minIn;
          if (diff < 0) diff += 24 * 60; // overnight wrap
          
          // Lunch break is 12:00 PM (720 minutes) to 1:00 PM (780 minutes)
          const lunchStart = 12 * 60; // 720 minutes (12:00 PM)
          const lunchEnd = 13 * 60;   // 780 minutes (1:00 PM)
          
          // Check if the on-site time spans across lunch break
          // Case 1: Starts before lunch and ends after lunch
          if (minIn < lunchStart && minOut > lunchEnd) {
            diff -= 60; // Subtract 1 hour (60 minutes) for lunch break
          }
          // Case 2: Starts during lunch (12:00-1:00 PM)
          else if (minIn >= lunchStart && minIn < lunchEnd) {
            // If starts at 12:00 exactly, or anytime during lunch hour, adjust end time
            if (minOut > lunchEnd) {
              // Started during lunch, ended after lunch - subtract time from lunch start
              diff = diff - (lunchEnd - minIn);
            }
          }
          // Case 3: Ends during lunch (12:00-1:00 PM)
          else if (minOut > lunchStart && minOut <= lunchEnd) {
            // Started before lunch, ended during lunch - subtract time until lunch start
            if (minIn < lunchStart) {
              diff = diff - (minOut - lunchStart);
            }
          }
          
          if (diff < 0) diff = 0; // Ensure non-negative
          durationOutput.value = formatMinutes(diff);
        } catch (e) {
          console.error('Error calculating duration:', e);
        }
      }

      if (timeInInput && timeOutInput && durationOutput) {
        timeInInput.addEventListener('change', updateDuration);
        timeOutInput.addEventListener('change', updateDuration);
      }

      function updateTravelDuration() {
        try {
          console.log('updateTravelDuration called');
          if (!travelStartInput || !travelEndInput || !travelDurationOutput) {
            console.log('Missing elements in updateTravelDuration');
            return;
          }
          const minStart = toMinutes(travelStartInput.value);
          const minEnd = toMinutes(travelEndInput.value);
          console.log('Travel times:', {
            start: travelStartInput.value,
            end: travelEndInput.value,
            minStart,
            minEnd
          });
          if (minStart == null || minEnd == null) {
            travelDurationOutput.value = '';
            return;
          }
          let diff = minEnd - minStart;
          if (diff < 0) diff += 24 * 60;
          const formatted = formatMinutes(diff);
          console.log('Calculated duration:', { diff, formatted });
          travelDurationOutput.value = formatted;
        } catch (e) {
          console.error('Error calculating travel duration:', e);
        }
      }

      if (travelStartInput && travelEndInput && travelDurationOutput) {
        // Using 'input' event covers both typing and selection changes
        travelStartInput.addEventListener('input', updateTravelDuration);
        travelEndInput.addEventListener('input', updateTravelDuration);
        console.log('Travel duration event listeners added');
      } else {
        console.log('Travel duration elements not found:', {
          travelStartInput: !!travelStartInput,
          travelEndInput: !!travelEndInput,
          travelDurationOutput: !!travelDurationOutput
        });
      }

      // Home travel duration calculation
      const homeTravelStartInput = document.getElementById('homeTravelStart');
      const homeTravelEndInput = document.getElementById('homeTravelEnd');
      const homeTravelDurationOutput = document.getElementById('homeTravelDuration');

      function updateHomeTravelDuration() {
        try {
          console.log('updateHomeTravelDuration called');
          if (!homeTravelStartInput || !homeTravelEndInput || !homeTravelDurationOutput) {
            console.log('Missing elements in updateHomeTravelDuration');
            return;
          }
          const minStart = toMinutes(homeTravelStartInput.value);
          const minEnd = toMinutes(homeTravelEndInput.value);
          console.log('Home travel times:', {
            start: homeTravelStartInput.value,
            end: homeTravelEndInput.value,
            minStart,
            minEnd
          });
          if (minStart == null || minEnd == null) {
            homeTravelDurationOutput.value = '';
            return;
          }
          let diff = minEnd - minStart;
          if (diff < 0) diff += 24 * 60;
          const formatted = formatMinutes(diff);
          console.log('Calculated home travel duration:', { diff, formatted });
          homeTravelDurationOutput.value = formatted;
        } catch (e) {
          console.error('Error calculating home travel duration:', e);
        }
      }

      if (homeTravelStartInput && homeTravelEndInput && homeTravelDurationOutput) {
        // Using 'input' event covers both typing and selection changes
        homeTravelStartInput.addEventListener('input', updateHomeTravelDuration);
        homeTravelEndInput.addEventListener('input', updateHomeTravelDuration);
        console.log('Home travel duration event listeners added');
      } else {
        console.log('Home travel duration elements not found:', {
          homeTravelStartInput: !!homeTravelStartInput,
          homeTravelEndInput: !!homeTravelEndInput,
          homeTravelDurationOutput: !!homeTravelDurationOutput
        });
      }

      // Enable auto-save functionality
      enableAutoSave();
      
      // Setup validation error clearing
      setupValidationClear();
      
      // Load draft if available (after delay to ensure all fields are initialized)
      setTimeout(() => {
        loadDraft();
      }, DRAFT_LOAD_DELAY_MS);

      // Check initial state and set project phase read-only if project code is "None"
      if (projectCodeSelect && projectCodeSelect.value === 'None') {
        const projectPhaseSelect = document.getElementById('projectPhase');
        const projectPhaseCustom = document.getElementById('projectPhaseCustom');
        if (projectPhaseSelect) {
          projectPhaseSelect.disabled = true;
          projectPhaseSelect.value = 'None';
        }
        if (projectPhaseCustom) {
          projectPhaseCustom.disabled = true;
          projectPhaseCustom.value = 'None';
        }
      }
    });

    // Burger menu functions
    function openMenu(){
      const overlay = document.getElementById('sideOverlay');
      const menu = document.getElementById('sideMenu');
      if (overlay) overlay.classList.add('show');
      if (menu) menu.classList.add('show');
    }
    function closeMenu(){
      const overlay = document.getElementById('sideOverlay');
      const menu = document.getElementById('sideMenu');
      if (overlay) overlay.classList.remove('show');
      if (menu) menu.classList.remove('show');
    }
    function toggleMenu(event){
      if (event && event.preventDefault) event.preventDefault();
      const menu = document.getElementById('sideMenu');
      if (menu && menu.classList.contains('show')) { closeMenu(); } else { openMenu(); }
    }

    // Close menu on ESC key
    document.addEventListener('keydown', (e) => { 
      if (e.key === 'Escape') {
        closeMenu();
        closeHistoryModal();
        closeReportDetailModal();
      }
    });

    // History modal functions
    async function openHistoryModal() {
      const modal = document.getElementById('historyModal');
      if (!modal) return;
      
      modal.classList.add('show');
      await loadHistory();
    }

    function closeHistoryModal() {
      const modal = document.getElementById('historyModal');
      if (modal) modal.classList.remove('show');
    }

    async function loadHistory() {
      const tbody = document.getElementById('historyTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;">Loading...</td></tr>';
      
      try {
        // Check if user is authenticated
        if (!window.DSRAuth || !DSRAuth.isLoggedIn()) {
          tbody.innerHTML = '<tr><td colspan="5" class="history-empty">Please log in to view your history.</td></tr>';
          return;
        }
        
        // Get current user info - use session data first for speed
        let username = null;
        const session = localStorage.getItem('dsr_session');
        if (session) {
          try {
            const engineerData = JSON.parse(session);
            username = engineerData.engineerCode || null;
          } catch (_) {}
        }
        
        // Only call API if session data missing
        if (!username) {
          try {
            const userInfo = await window.DSRAuth.me();
            username = userInfo && userInfo.user ? userInfo.user.username : null;
          } catch (_) {}
        }
        
        // Ensure API base is resolved (cached, fast)
        await resolveApiBase();
        
        // Fetch reports - backend automatically filters by logged-in user
        const headers = Object.assign({ 'Accept': 'application/json' }, 
          (window.DSRAuth && DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
        let baseUrl = window.DSRAuth && DSRAuth.getApiBase ? DSRAuth.getApiBase() : '';
        
        // Fallback: use resolved API_BASE or determine from context
        if (!baseUrl) {
          if (typeof API_BASE !== 'undefined' && API_BASE) {
            baseUrl = API_BASE;
          } else if (window.location.protocol === 'file:') {
            baseUrl = 'http://127.0.0.1:5000';
          } else {
            baseUrl = window.location.origin;
          }
        }
        
        // Ensure URL doesn't have double slashes and is properly formatted
        const cleanBaseUrl = baseUrl.replace(/\/$/, '');
        const url = cleanBaseUrl + '/reports';
        
        let res;
        try {
          res = await fetch(url, { 
            headers,
            method: 'GET',
            credentials: 'omit',
            redirect: 'manual' // Don't follow redirects automatically
          });
          
          // Handle redirects manually
          if (res.type === 'opaqueredirect' || res.status === 301 || res.status === 302 || res.status === 307 || res.status === 308) {
            const location = res.headers.get('location');
            throw new Error(`Server redirected to: ${location || 'unknown'}. This may indicate an authentication issue.`);
          }
        } catch (fetchError) {
          console.error('Network error fetching history:', fetchError);
          if (fetchError.message && fetchError.message.includes('redirected')) {
            throw fetchError; // Re-throw redirect errors as-is
          }
          throw new Error(`Network error: ${fetchError.message}. Please check if the server is running at ${url}`);
        }
        
        console.log('Response status:', res.status, res.statusText);
        console.log('Response headers:', Object.fromEntries(res.headers.entries()));
        
        // Check if response is JSON before parsing
        const contentType = res.headers.get('content-type') || '';
        let data;
        
        if (contentType.includes('application/json')) {
          try {
            data = await res.json();
          } catch (jsonError) {
            // Even if content-type says JSON, parsing might fail
            const text = await res.text();
            console.error('Failed to parse JSON. Response text:', text.substring(0, 500));
            throw new Error(`Invalid JSON response. Server returned: ${text.substring(0, 100)}...`);
          }
        } else {
          // If not JSON, try to get text to see what we got
          const text = await res.text();
          console.error('Non-JSON response received. Status:', res.status);
          console.error('Content-Type:', contentType);
          console.error('Response preview:', text.substring(0, 500));
          
          if (res.status === 401 || res.status === 403) {
            throw new Error('Authentication required. Please log in again.');
          } else if (res.status === 404) {
            throw new Error(`API endpoint not found (404). URL: ${url}`);
          } else if (res.status >= 500) {
            throw new Error(`Server error (${res.status}). Please check server logs.`);
          } else {
            throw new Error(`Unexpected response (${res.status}). Expected JSON but received: ${contentType}`);
          }
        }
        
        console.log('History response:', { ok: res.ok, status: res.status, data });
        
        if (!res.ok || !data.ok) {
          throw new Error(data.error || `Failed to load history (HTTP ${res.status})`);
        }
        
        let reports = data.items || [];
        console.log('Received reports:', reports.length);
        console.log('Report details:', reports.map(r => ({ id: r.id, engineerName: r.engineerName, date: r.reportDate })));
        
        if (reports.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="history-empty">No reports found for user "${username}".<br>Submit a new report to see it here!</td></tr>`;
          return;
        }
        
        // Sort by ID in descending order (highest ID first - newest reports)
        reports.sort((a, b) => {
          const idA = parseInt(a.id) || 0;
          const idB = parseInt(b.id) || 0;
          return idB - idA;
        });
        
        tbody.innerHTML = '';
        reports.forEach((report, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${report.reportDate || ''}</td>
            <td>${report.projectCode || ''}</td>
            <td>${report.projectName || ''}</td>
            <td>
              <button class="view-btn" onclick="viewHistoryDetail(${report.id})">View</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (error) {
        console.error('Error loading history:', error);
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:20px;color:#ef4444;">Error loading history: ${error.message}</td></tr>`;
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]); });
    }

    // Helper functions for time duration calculation (matching admin.html)
    function parse12HourTime(timeStr) {
      if (!timeStr || timeStr === 'N/A') return null;
      const match = timeStr.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
      if (!match) return null;
      let hours = parseInt(match[1], 10);
      const minutes = parseInt(match[2], 10);
      const period = match[3].toUpperCase();
      if (period === 'PM' && hours !== 12) hours += 12;
      if (period === 'AM' && hours === 12) hours = 0;
      return hours * 60 + minutes;
    }

    function calculateDuration(time1, time2) {
      const min1 = parse12HourTime(time1);
      const min2 = parse12HourTime(time2);
      if (min1 == null || min2 == null) return null;
      let diff = min2 - min1;
      if (diff < 0) diff += 24 * 60; // Handle overnight
      return diff;
    }

    // Calculate on-site duration with lunch break deduction (12-1 PM)
    function calculateOnSiteDuration(timeIn, timeOut) {
      const min1 = parse12HourTime(timeIn);
      const min2 = parse12HourTime(timeOut);
      if (min1 == null || min2 == null) return null;
      
      let diff = min2 - min1;
      if (diff < 0) diff += 24 * 60; // Handle overnight
      
      // Lunch break is 12:00 PM (720 minutes) to 1:00 PM (780 minutes)
      const lunchStart = 12 * 60; // 720 minutes (12:00 PM)
      const lunchEnd = 13 * 60;   // 780 minutes (1:00 PM)
      
      // Check if the on-site time spans across lunch break
      // Case 1: Starts before lunch and ends after lunch
      if (min1 < lunchStart && min2 > lunchEnd) {
        diff -= 60; // Subtract 1 hour (60 minutes) for lunch break
      }
      // Case 2: Starts during lunch (12:00-1:00 PM)
      else if (min1 >= lunchStart && min1 < lunchEnd) {
        // If starts at 12:00 exactly, or anytime during lunch hour, adjust end time
        if (min2 > lunchEnd) {
          // Started during lunch, ended after lunch - subtract time from lunch start
          diff = diff - (lunchEnd - min1);
        }
      }
      // Case 3: Ends during lunch (12:00-1:00 PM)
      else if (min2 > lunchStart && min2 <= lunchEnd) {
        // Started before lunch, ended during lunch - subtract time until lunch start
        if (min1 < lunchStart) {
          diff = diff - (min2 - lunchStart);
        }
      }
      
      return diff >= 0 ? diff : 0; // Ensure non-negative
    }

    function formatDuration(minutes) {
      if (minutes == null) return '';
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      const hLabel = hours === 1 ? 'hour' : 'hours';
      const mLabel = mins === 1 ? 'minute' : 'minutes';
      if (hours === 0) {
        return `${mins} ${mLabel}`;
      }
      if (mins === 0) {
        return `${hours} ${hLabel}`;
      }
      return `${hours} ${hLabel} ${mins} ${mLabel}`;
    }

    async function viewHistoryDetail(reportId) {
      try {
        const headers = Object.assign({ 'Accept': 'application/json' }, 
          (window.DSRAuth && DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
        const baseUrl = window.DSRAuth && DSRAuth.getApiBase ? DSRAuth.getApiBase() : '';
        const url = `${baseUrl}/reports/${reportId}`;
        
        const res = await fetch(url, { headers });
        
        // Check if response is JSON before parsing
        const contentType = res.headers.get('content-type') || '';
        let data;
        
        if (contentType.includes('application/json')) {
          data = await res.json();
        } else {
          // If not JSON, try to get text to see what we got
          const text = await res.text();
          console.error('Non-JSON response received:', text.substring(0, 200));
          
          if (res.status === 401 || res.status === 403) {
            throw new Error('Authentication required. Please log in again.');
          } else if (res.status === 404) {
            throw new Error('Report not found.');
          } else {
            throw new Error(`Server error (${res.status}). Expected JSON but received: ${contentType}`);
          }
        }
        
        if (!res.ok || !data.ok) {
          throw new Error(data.error || 'Failed to load report details');
        }
        
        const report = data.item || {};
        
        // Calculate overtime based on on-site duration (beyond 9 hours)
        // On-site duration with lunch break deduction (12-1 PM)
        const onSiteDuration = calculateOnSiteDuration(report.onSiteTimeIn, report.onSiteTimeOut);
        const standardShiftMinutes = 9 * 60; // 9 hours
        let overtimeText = 'N/A';
        
        if (onSiteDuration != null && onSiteDuration > standardShiftMinutes) {
          const overtimeMinutes = onSiteDuration - standardShiftMinutes;
          overtimeText = formatDuration(overtimeMinutes);
        }
        
        // Format engineer name with correct initials based on code
        const formattedEngineerName = formatEngineerNameForHistory(report.engineerName, report.engineerCode);
        
        // Show detail in a formatted modal
        const detailModal = document.getElementById('reportDetailModal');
        const detailTitle = document.getElementById('reportDetailTitle');
        const detailBody = document.getElementById('reportDetailBody');
        
        if (!detailModal || !detailTitle || !detailBody) {
          // Fallback to alert if modal elements don't exist
          alert(`Report #${report.id}\nDate: ${report.reportDate}\nEngineer: ${formattedEngineerName}\nProject: ${report.projectCode} - ${report.projectName}`);
          return;
        }
        
        detailTitle.textContent = `Report #${report.id} — ${formattedEngineerName}`;
        
        // Show and configure PDF button
        const printBtn = document.getElementById('reportDetailPrintBtn');
        if (printBtn) {
          printBtn.style.display = 'inline-flex';
          printBtn.setAttribute('onclick', `printReportToPDF(${report.id})`);
        }
        
        detailBody.innerHTML = `
          <div style="background: #fafafa; padding: 20px; border-radius: 0; margin-bottom: 20px; border: 2px solid #0e1111; border-left: 6px solid #0e1111;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Report Date:</strong><br><span style="color: #0e1111; margin-top: 4px; display: inline-block;">${report.reportDate || 'N/A'}</span></div>
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Engineer:</strong><br><span style="color: #0e1111; margin-top: 4px; display: inline-block;">${escapeHtml(formattedEngineerName)}</span></div>
            </div>
          </div>

          <fieldset style="border: 2px solid #0e1111; border-radius: 0; padding: 20px; margin-bottom: 20px; background: #ffffff;">
            <legend style="font-weight: 800; color: #0e1111; padding: 0 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; background: #ffffff; border: 2px solid #0e1111;">Project Information</legend>
            <div style="display: grid; gap: 14px;">
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Project Phase:</strong> <span style="color: #0e1111; margin-left: 8px;">${escapeHtml(report.projectPhase || 'N/A')}</span></div>
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Project Code:</strong> <span style="color: #0e1111; margin-left: 8px;">${escapeHtml(report.projectCode || 'N/A')}</span></div>
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Project Name:</strong> <span style="color: #0e1111; margin-left: 8px;">${escapeHtml(report.projectName || 'N/A')}</span></div>
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Client Name:</strong> <span style="color: #0e1111; margin-left: 8px;">${escapeHtml(report.clientName || 'N/A')}</span></div>
              <div><strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px;">Plant Location:</strong> <span style="color: #0e1111; margin-left: 8px;">${escapeHtml(report.plantLocation || 'N/A')}</span></div>
            </div>
          </fieldset>

          <fieldset style="border: 2px solid #0e1111; border-radius: 0; padding: 20px; margin-bottom: 20px; background: #ffffff;">
            <legend style="font-weight: 800; color: #0e1111; padding: 0 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; background: #ffffff; border: 2px solid #0e1111; font-family: Helvetica, Arial, sans-serif;">Time Details</legend>
            <div style="display: flex; flex-direction: column; gap: 16px; font-family: Helvetica, Arial, sans-serif;">
                <div>
                <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; font-family: Helvetica, Arial, sans-serif;">Travel Time to Plant Site</strong>
                <div style="margin-left: 16px; display: flex; gap: 32px; align-items: baseline;">
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">Start:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.travelTimeToSite || 'N/A'}</span>
                </div>
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">End:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.travelTimeFromSite || 'N/A'}</span>
              </div>
                </div>
              </div>
                <div>
                <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; font-family: Helvetica, Arial, sans-serif;">On-Site</strong>
                <div style="margin-left: 16px; display: flex; gap: 32px; align-items: baseline;">
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">Start:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.onSiteTimeIn || 'N/A'}</span>
                </div>
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">End:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.onSiteTimeOut || 'N/A'}</span>
              </div>
                </div>
              </div>
                <div>
                <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; font-family: Helvetica, Arial, sans-serif;">Travel Time to Home Base</strong>
                <div style="margin-left: 16px; display: flex; gap: 32px; align-items: baseline;">
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">Start:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.travelTimeToHomeBase || 'N/A'}</span>
                </div>
                  <div style="display: flex; align-items: baseline; min-width: 120px;">
                    <strong style="color: #0e1111; font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; width: 60px; font-family: Helvetica, Arial, sans-serif;">End:</strong> <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${report.travelTimeOut || 'N/A'}</span>
              </div>
                </div>
              </div>
                <div>
                <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; font-family: Helvetica, Arial, sans-serif;">Overtime</strong>
                <div style="margin-left: 16px;">
                  <span style="color: #0e1111; font-family: Helvetica, Arial, sans-serif;">${overtimeText || 'N/A'}</span>
                </div>
              </div>
            </div>
          </fieldset>

          <fieldset style="border: 2px solid #0e1111; border-radius: 0; padding: 20px; margin-bottom: 20px; background: #ffffff;">
            <legend style="font-weight: 800; color: #0e1111; padding: 0 12px; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Work Details</legend>
            <div style="margin-bottom: 16px;">
              <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Work Objective:</strong>
              <div style="background: #ffffff; padding: 14px; border-radius: 0; border: 2px solid #0e1111; white-space: pre-wrap; color: #0e1111; line-height: 1.6;">${escapeHtml(report.workObjective || 'N/A')}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Description:</strong>
              <div style="background: #ffffff; padding: 14px; border-radius: 0; border: 2px solid #0e1111; white-space: pre-wrap; color: #0e1111; line-height: 1.6;">${escapeHtml(report.description || 'N/A')}</div>
            </div>
              <div>
              <strong style="color: #0e1111; font-weight: 700; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 8px;">Outcome:</strong>
              <div style="background: #ffffff; padding: 14px; border-radius: 0; border: 2px solid #0e1111; white-space: pre-wrap; color: #0e1111; line-height: 1.6;">${escapeHtml(report.outcome || 'N/A')}</div>
            </div>
          </fieldset>
        `;
        
        detailModal.classList.add('show');
      } catch (error) {
        alert('Error loading report details: ' + error.message);
      }
    }

    function closeReportDetailModal() {
      const detailModal = document.getElementById('reportDetailModal');
      if (detailModal) detailModal.classList.remove('show');
      // Hide PDF button when modal closes
      const printBtn = document.getElementById('reportDetailPrintBtn');
      if (printBtn) printBtn.style.display = 'none';
    }

    async function printReportToPDF(reportId) {
      if (!reportId) {
        alert('Report ID is missing');
        return;
      }
      try {
        // Get the modal content (header and body)
        const detailModal = document.getElementById('reportDetailModal');
        const detailTitle = document.getElementById('reportDetailTitle');
        const detailBody = document.getElementById('reportDetailBody');
        
        if (!detailModal || !detailTitle || !detailBody) {
          alert('Report detail modal is not open. Please view the report first.');
          return;
        }
        
        // Get the header and body content
        const headerContent = detailTitle.innerHTML || detailTitle.textContent || '';
        const bodyContent = detailBody.innerHTML || '';

        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        iframe.style.visibility = 'hidden';
        iframe.setAttribute('aria-hidden', 'true');

        let printed = false;

        iframe.addEventListener('load', () => {
          if (printed) return;
          printed = true;
          setTimeout(() => {
            try {
              const frameWindow = iframe.contentWindow;
              if (frameWindow) {
                frameWindow.focus();
                frameWindow.print();
              } else {
                throw new Error('Unable to access print window');
              }
            } catch (err) {
              console.error('Print error:', err);
              alert('Unable to start printing. Please try again.');
            } finally {
              setTimeout(() => {
                if (iframe.parentNode) {
                  iframe.parentNode.removeChild(iframe);
                }
              }, 200);
            }
          }, 50);
        }, { once: true });

        iframe.srcdoc = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>${headerContent}</title>
            <style>
              :root {
                --print-scale: 0.88;
                --print-font-size: 11.5px;
              }
              @media print {
                @page {
                  size: A4 portrait;
                  margin: 5mm;
                }
                body {
                  zoom: var(--print-scale);
                }
              }
              body {
                margin: 0;
                padding: 10px 14px;
                font-family: Helvetica, Arial, sans-serif;
                font-size: var(--print-font-size);
                color: #0e1111;
++ Continue the patch after line 3073 ***
                background: #fff;
              }
              fieldset {
                border: 2px solid #0e1111;
                border-radius: 0;
                padding: 20px;
                margin-bottom: 20px;
                background: #fff;
                page-break-inside: avoid;
              }
              legend {
                font-weight: 800;
                color: #0e1111;
                padding: 0 12px;
                font-size: 14px;
                text-transform: uppercase;
                letter-spacing: 1px;
                background: #ffffff;
                border: 2px solid #0e1111;
              }
            </style>
          </head>
          <body>
            <h2>${headerContent}</h2>
            ${bodyContent}
          </body>
          </html>
        `;

        document.body.appendChild(iframe);
      } catch (error) {
        alert('Error printing report: ' + error.message);
      }
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      const historyModal = document.getElementById('historyModal');
      if (historyModal && e.target === historyModal) {
        closeHistoryModal();
      }
      const detailModal = document.getElementById('reportDetailModal');
      if (detailModal && e.target === detailModal) {
        closeReportDetailModal();
      }
    });
  </script>
</head>
<body>
  <div class="brand-header">
    <h1>dot[X].solutions</h1>
    <button id="menuBtn" class="burger-btn" aria-label="Menu" title="Menu" onclick="toggleMenu(event)">
      <span class="line"></span>
      <span class="line"></span>
      <span class="line"></span>
    </button>
  </div>
  <div id="sideOverlay" class="menu-overlay" onclick="closeMenu()"></div>
  <nav id="sideMenu" class="side-menu">
    <div class="menu-item" onclick="closeMenu(); openHistoryModal()">History</div>
    <div class="menu-item" onclick="closeMenu(); openLogoutConfirm(event, null)" style="color: #ef4444;">Logout</div>
  </nav>
  <div class="container">
    <div class="topbar">
      <h1>Daily Service Report</h1>
      <div class="meta">
        <div class="user-info">
          <span class="user-name" id="currentUserName">Loading...</span>
        </div>
      </div>
    </div>


    <div>
    <form id="dsrForm" onsubmit="submitForm(event)" novalidate>
      <fieldset>
        <legend>General</legend>
        <div class="row">
          <div>
            <label for="reportDate">Report date</label>
            <input type="date" id="reportDate">
          </div>
          <div>
            <label for="projectPhase">Project Phase</label>
            <select id="projectPhase">
            <option value="" selected>Select Project Phase</option>
            <option>None</option>
            <option>Site Inspection</option>
            <option>Planning</option>
            <option>Execution</option>
            <option>Monitoring</option>
            <option>Closure</option>
            </select> 
            <input type="text" id="projectPhaseCustom" placeholder="Enter custom project phase" style="display: none; margin-top: 8px;">
          </div>
        </div>
        <div class="row">
          <div> 
            <label for="engineerNumber">Engineer Number</label>
            <input type="text" id="engineerNumber" placeholder="Enter Engineer Number" readonly>
          </div>
        <div>
          <label for="engineerName">Engineer Name</label>
            <input type="text" id="engineerName" placeholder="Engineer Name" readonly>
          </div>
        </div>
         <div class="row">
         <div>
            <label for="projectCode">Project Code</label>
            <select id="projectCode">
            <option value="" selected>Select Project Code</option>
            </select>
            <input type="text" id="projectCodeCustom" placeholder="Enter custom project code" style="display: none; margin-top: 8px;">
          </div>
          <div>
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" placeholder="Project Name">
            <select id="projectNameSelect" style="display: none; margin-top: 8px;"></select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="Client Name">
            <select id="clientNameSelect" style="display: none; margin-top: 8px;"></select>
          </div>
          <div>
            <label for="plantLocation">Plant Location</label>
            <input type="text" id="plantLocation" placeholder="Plant Location">
            <select id="plantLocationSelect" style="display: none; margin-top: 8px;"></select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Travel Time to Plant Site</legend>
        <div class="row">
          <div>
            <label for="travelTimeToSite">Start Time</label>
            <input type="time" id="travelTimeToSite">
          </div>
          <div>
            <label for="travelTimeFromSite">End Time</label>
            <input type="time" id="travelTimeFromSite">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="travelDuration">Duration</label>
            <input type="text" id="travelDuration" class="duration-input" placeholder="0 hours 00 minutes" readonly>
          </div>
          <div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>On-Site</legend>
        <div class="row">
          <div>
            <label for="onSiteTimeIn">Start Time</label>
            <input type="time" id="onSiteTimeIn">
          </div>
          <div>
            <label for="onSiteTimeOut">End Time</label>
            <input type="time" id="onSiteTimeOut">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="onSiteDuration">Duration</label>
            <input type="text" id="onSiteDuration" class="duration-input" placeholder="0 hours 00 minutes" readonly>
          </div>
          <div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Travel Time to Home Base</legend>
        <div class="row">
          <div>
            <label for="homeTravelStart">Start Time</label>
            <input type="time" id="homeTravelStart">
          </div>
          <div>
            <label for="homeTravelEnd">End Time</label>
            <input type="time" id="homeTravelEnd">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="homeTravelDuration">Duration</label>
            <input type="text" id="homeTravelDuration" class="duration-input" placeholder="0 hours 00 minutes" readonly>
          </div>
          <div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Details</legend>
        <label for="workObjective">Work objective</label>
        <textarea id="workObjective"></textarea>
        <label for="description">Description</label>
        <textarea id="description"></textarea>
        <label for="outcome">Outcome</label>
        <textarea id="outcome"></textarea>
      </fieldset>

      <div class="actions" style="justify-content: center;">
        <button type="submit">Submit report</button>
      </div>
      </form>
    </div>

  </div>
  <!-- Logout confirmation modal -->
  <div id="logoutOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
    <div class="modal-dialog">
      <p id="logoutTitle">Are you sure you want to logout?</p>
      <div class="modal-actions">
        <button type="button" class="yes-btn" onclick="confirmLogout()">YES</button>
        <button type="button" class="no-btn" onclick="cancelLogout()">NO</button>
      </div>  
    </div>
  </div>

  <!-- Success modal -->
  <div id="successOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="successTitle">
    <div class="modal-dialog">
      <p id="successTitle" style="color: #065f46; font-size: 18px;">Successfully Submitted!</p>
      <p style="color: #6b7280; font-size: 14px; margin-top: 8px;">Your report has been saved and added to your history.</p>
      <div class="modal-actions">
        <button type="button" class="ok-btn" onclick="closeSuccessModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- History modal -->
  <div id="historyModal" class="history-modal-overlay" role="dialog" aria-modal="true">
    <div class="history-modal-dialog">
      <div class="history-brand-header">
        <div>
          <p class="history-brand-title">dot[X].solutions</p>
        </div>
        <div style="display:flex; align-items:center; gap:12px;">
          <button type="button" class="history-brand-close" onclick="closeHistoryModal()">Close</button>
        </div>
      </div>
      <div class="history-modal-header">

       </div>
      <div class="history-modal-body">
        <table class="history-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Date</th>
              <th>Project Code</th>
              <th>Project Name</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="historyTableBody">
            <tr><td colspan="5" style="text-align:center;padding:20px;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Draft Restore Modal -->
  <div id="draftRestoreModal" class="draft-restore-modal" role="dialog" aria-modal="true">
    <div class="draft-restore-dialog">
      <div class="draft-restore-header">
        <div class="draft-restore-icon">💾</div>
        <h2 class="draft-restore-title">Draft Found</h2>
      </div>
      <p class="draft-restore-message">
        We found an unsaved draft of your Daily Service Report. Would you like to restore it and continue where you left off?
      </p>
      <div class="draft-restore-timestamp" id="draftTimestamp">
        <strong>Last saved:</strong>
        <span>Loading...</span>
      </div>
      <div class="draft-restore-actions">
        <button type="button" class="draft-restore-btn" onclick="restoreDraft()">
          ✓ Restore Draft
        </button>
        <button type="button" class="draft-discard-btn" onclick="discardDraft()">
          Start Fresh
        </button>
      </div>
    </div>
  </div>

  <!-- Report Detail Modal -->
  <div id="reportDetailModal" class="history-modal-overlay" role="dialog" aria-modal="true" onclick="if(event.target===this) closeReportDetailModal()">
    <div class="history-modal-dialog" onclick="event.stopPropagation()" style="max-width: 900px;">
      <div class="history-modal-header">
        <h2 id="reportDetailTitle">Report Details</h2>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button id="reportDetailPrintBtn" class="print-btn-modal" onclick="printReportToPDF(null)" title="Print to PDF" style="display: none;">📄</button>
          <button class="secondary" onclick="closeReportDetailModal()" style="padding:10px 20px;border-radius:4px;cursor:pointer;background:#ffffff;color:#0e1111;border:2px solid #0e1111;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;transition:all 0.2s;font-size:12px;">Close</button>
        </div>
      </div>
      <div class="history-modal-body" id="reportDetailBody">
        <p style="text-align:center;padding:20px;">Loading...</p>
      </div>
    </div>
  </div>
</body>
</html>

 
