<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Project Lists - Daily Service Reports</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  STYLE_SECTION
  <script src="auth.js"></script>
  <script>
    function qs(id){ return document.getElementById(id); }
    async function ensureAdmin() {
      try {
        if (!window.DSRAuth || !DSRAuth.isLoggedIn()) {
          window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
          return false;
        }
        const me = await DSRAuth.me();
        if (!me.ok || !me.authenticated || !me.user || me.user.role !== 'admin') {
          alert('Admin access required');
          window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
          return false;
        }
        return true;
      } catch (_) {
        window.location.replace('login.html?redirect=' + encodeURIComponent('projects.html'));
        return false;
      }
    }

    function uniq(arr) { const s = new Set(); const out = []; for (const v of arr) { const sv = String(v||'').trim(); if (sv && !s.has(sv)) { s.add(sv); out.push(sv); } } return out; }

    // Global projects array - loaded from backend
    let projects = [];

    // Track if we're editing or adding
    let isEditMode = false;
    let editingProjectCode = null;

    // Fetch projects from backend
    async function fetchProjectsFromBackend() {
      try {
        const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
        const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs';
        const res = await fetch(url, { headers });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          throw new Error(data.error || ('HTTP ' + res.status));
        }
        return data.items || [];
      } catch (e) {
        console.error('Error fetching projects:', e);
        throw e;
      }
    }

    async function loadProjects() {
      // Fetch projects from backend first
      try {
        projects = await fetchProjectsFromBackend();
      } catch (e) {
        alert('Failed to load projects: ' + (e && e.message ? e.message : String(e)));
        projects = [];
      }
      const list = qs('list');
      list.innerHTML = '';

      const topBar = document.createElement('div');
      topBar.className = 'project-controls';
      topBar.style.display = 'flex';
      topBar.style.gap = '12px';
      topBar.style.alignItems = 'center';
      topBar.style.marginBottom = '12px';
      topBar.style.justifyContent = 'center';
      topBar.style.flexWrap = 'wrap';
      topBar.innerHTML = `
        <input id="searchInput" type="text" placeholder="Search projects..." style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:6px;font-size:13px;max-width:250px;flex:1;">
        <button id="addProjectBtn" style="background:#2563eb;color:#fff;border:0;font-weight:600;cursor:pointer;">+ Add Project</button>
      `;
      list.appendChild(topBar);

      const tableWrap = document.createElement('div');
      tableWrap.className = 'table-center';
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr>
            <th>Project Code</th>
            <th>PO/Start Date</th>
            <th>Client</th>
            <th>Project Name</th>
            <th>Industry</th>
            <th>Location</th>
            <th>PIC</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');
      
      function renderRows(rows) {
        tbody.innerHTML = '';
        for (const p of rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.code}</td>
            <td>${p.startDate}</td>
            <td>${p.client}</td>
            <td>${p.name}</td>
            <td>${p.industry}</td>
            <td>${p.location}</td>
            <td>${p.pic}</td>
            <td class=\"actions-cell\"><button data-act=\"delete\" data-code=\"${p.code}\">Delete</button><button data-act=\"edit\" data-code=\"${p.code}\">Edit</button></td>
          `;
          tbody.appendChild(tr);
        }
        
        // Add event listeners to all action buttons
        tbody.querySelectorAll('button[data-act]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.target.getAttribute('data-act');
            const code = e.target.getAttribute('data-code');
            if (action === 'edit') {
              editProject(code);
            } else if (action === 'delete') {
              deleteProject(code);
            }
          });
        });
      }
      
      renderRows(projects);
      tableWrap.appendChild(table);
      list.appendChild(tableWrap);
      
      // Add search functionality
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const query = searchInput.value.trim().toLowerCase();
          const filtered = projects.filter(p => 
            (p.code + ' ' + p.name + ' ' + p.client + ' ' + p.location).toLowerCase().includes(query)
          );
          renderRows(filtered);
        });
      }
    }

    function openAddProjectModal() {
      isEditMode = false;
      editingProjectCode = null;
      
      qs('projectCode').disabled = false; // Enable project code field for new projects
      
      // Try to load draft from localStorage
      const draft = loadDraft();
      if (draft) {
        // Show custom draft notification modal
        showDraftNotification(draft);
      } else {
        // No draft, clear form fields and open modal
        clearFormFields();
        openProjectFormModal();
      }
    }

    function openProjectFormModal() {
      // Update modal title
      qs('modalTitle').textContent = 'PROJECT DETAILS - ADD NEW';
      
      qs('addProjectModal').classList.add('show');
      
      // Enable auto-save for draft
      enableDraftAutoSave();
    }

    function showDraftNotification(draft) {
      // Show the draft notification modal
      qs('draftModal').classList.add('show');
    }

    function useDraftData() {
      if (isEditMode) {
        useEditDraftData();
      } else {
        const draft = loadDraft();
        if (draft) {
          // Load draft data
          qs('projectCode').value = draft.code || '';
          qs('startDate').value = draft.startDate || '';
          qs('clientName').value = draft.client || '';
          qs('projectName').value = draft.name || '';
          qs('industry').value = draft.industry || '';
          qs('location').value = draft.location || '';
          qs('pic').value = draft.pic || '';
        }
        
        // Close draft notification and open project form
        qs('draftModal').classList.remove('show');
        openProjectFormModal();
      }
    }

    function discardDraft() {
      if (isEditMode) {
        discardEditDraft();
      } else {
        // Clear draft and form
        clearDraft();
        clearFormFields();
        
        // Close draft notification and open project form
        qs('draftModal').classList.remove('show');
        openProjectFormModal();
      }
    }

    function clearFormFields() {
      qs('projectCode').value = '';
      qs('startDate').value = '';
      qs('clientName').value = '';
      qs('projectName').value = '';
      qs('industry').value = '';
      qs('location').value = '';
      qs('pic').value = '';
    }

    function editProject(code) {
      const project = projects.find(p => p.code === code);
      if (!project) {
        alert('Project not found!');
        return;
      }
      
      isEditMode = true;
      editingProjectCode = code;
      
      qs('projectCode').disabled = true; // Disable project code field when editing
      
      // Try to load edit draft for this specific project
      const editDraft = loadEditDraft(code);
      if (editDraft) {
        // Show custom draft notification modal for edit
        showEditDraftNotification(editDraft, project);
      } else {
        // No draft, load original project data
        loadProjectDataToForm(project);
        openEditFormModal();
      }
    }

    function loadProjectDataToForm(project) {
      qs('projectCode').value = project.code;
      qs('startDate').value = project.startDate;
      qs('clientName').value = project.client;
      qs('projectName').value = project.name;
      qs('industry').value = project.industry;
      qs('location').value = project.location;
      qs('pic').value = project.pic;
    }

    function openEditFormModal() {
      // Update modal title
      qs('modalTitle').textContent = 'PROJECT DETAILS - EDIT';
      
      qs('addProjectModal').classList.add('show');
      
      // Enable auto-save for draft in edit mode
      enableDraftAutoSave();
    }

    function showEditDraftNotification(draft, originalProject) {
      // Store original project for comparison
      window.originalProjectBeforeEdit = originalProject;
      
      // Show the draft notification modal
      qs('draftModal').classList.add('show');
    }

    function useEditDraftData() {
      const draft = loadEditDraft(editingProjectCode);
      if (draft) {
        // Load draft data
        qs('projectCode').value = draft.code;
        qs('startDate').value = draft.startDate || '';
        qs('clientName').value = draft.client || '';
        qs('projectName').value = draft.name || '';
        qs('industry').value = draft.industry || '';
        qs('location').value = draft.location || '';
        qs('pic').value = draft.pic || '';
      }
      
      // Close draft notification and open project form
      qs('draftModal').classList.remove('show');
      openEditFormModal();
    }

    function discardEditDraft() {
      // Load original project data
      const project = projects.find(p => p.code === editingProjectCode);
      if (project) {
        loadProjectDataToForm(project);
      }
      
      // Clear edit draft
      clearEditDraft(editingProjectCode);
      
      // Close draft notification and open project form
      qs('draftModal').classList.remove('show');
      openEditFormModal();
    }

    let projectToDelete = null;

    function deleteProject(code) {
      const project = projects.find(p => p.code === code);
      if (!project) {
        showSuccessModal('Error', 'Project not found!');
        return;
      }
      
      // Store project info for deletion
      projectToDelete = { code: code, name: project.name };
      
      // Show delete confirmation modal
      qs('deleteModalText').innerHTML = `Are you sure you want to delete project<br><strong>"${project.name}"</strong><br>(${code})?`;
      qs('deleteModal').classList.add('show');
    }

    async function confirmDelete() {
      if (projectToDelete) {
        try {
          // Delete from backend
          const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs/' + encodeURIComponent(projectToDelete.code);
          const res = await fetch(url, { method: 'DELETE', headers });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          // Close delete modal
          qs('deleteModal').classList.remove('show');
          
          // Show success message
          showSuccessModal('Project Deleted!', `"${projectToDelete.name}" has been successfully deleted.`);
          
          // Reload the projects list from backend
          await loadProjects();
          
          projectToDelete = null;
        } catch (e) {
          // Close modal first
          qs('deleteModal').classList.remove('show');
          alert('Failed to delete project: ' + (e && e.message ? e.message : String(e)));
          projectToDelete = null;
        }
      }
    }

    function cancelDelete() {
      qs('deleteModal').classList.remove('show');
      projectToDelete = null;
    }

    function closeAddProjectModal() {
      qs('addProjectModal').classList.remove('show');
      
      const hasContent = qs('projectCode').value.trim() || 
                        qs('startDate').value.trim() || 
                        qs('clientName').value.trim() || 
                        qs('projectName').value.trim() || 
                        qs('industry').value.trim() || 
                        qs('location').value.trim() || 
                        qs('pic').value.trim();
      
      if (hasContent) {
        if (isEditMode && editingProjectCode) {
          // Save edit draft with project code
          saveEditDraft(editingProjectCode);
        } else {
          // Save add draft
          saveDraft();
        }
      }
      
      isEditMode = false;
      editingProjectCode = null;
    }

    // Draft management functions
    function saveDraft() {
      const draft = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      // Only save if at least one field has content
      const hasContent = Object.values(draft).some(val => val && val !== draft.timestamp);
      if (hasContent) {
        localStorage.setItem('projectDraft', JSON.stringify(draft));
      }
    }

    function loadDraft() {
      try {
        const draftStr = localStorage.getItem('projectDraft');
        if (draftStr) {
          return JSON.parse(draftStr);
        }
      } catch (e) {
        console.error('Error loading draft:', e);
      }
      return null;
    }

    function clearDraft() {
      localStorage.removeItem('projectDraft');
    }

    // Edit draft management functions
    function saveEditDraft(projectCode) {
      const draft = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim(),
        timestamp: new Date().toISOString()
      };
      
      // Only save if at least one field has content
      const hasContent = Object.values(draft).some(val => val && val !== draft.timestamp);
      if (hasContent) {
        localStorage.setItem(`projectEditDraft_${projectCode}`, JSON.stringify(draft));
      }
    }

    function loadEditDraft(projectCode) {
      try {
        const draftStr = localStorage.getItem(`projectEditDraft_${projectCode}`);
        if (draftStr) {
          return JSON.parse(draftStr);
        }
      } catch (e) {
        console.error('Error loading edit draft:', e);
      }
      return null;
    }

    function clearEditDraft(projectCode) {
      localStorage.removeItem(`projectEditDraft_${projectCode}`);
    }

    function enableDraftAutoSave() {
      // Auto-save draft as user types (works for both add and edit modes)
      const fields = ['projectCode', 'startDate', 'clientName', 'projectName', 'industry', 'location', 'pic'];
      fields.forEach(fieldId => {
        const field = qs(fieldId);
        if (field) {
          // Remove existing listeners to avoid duplicates
          const newField = field.cloneNode(true);
          field.parentNode.replaceChild(newField, field);
          
          newField.addEventListener('input', () => {
            if (isEditMode && editingProjectCode) {
              saveEditDraft(editingProjectCode);
            } else if (!isEditMode) {
              saveDraft();
            }
          });
        }
      });
    }

    // Close modals when clicking outside
    document.addEventListener('click', (e) => {
      const addModal = qs('addProjectModal');
      const deleteModal = qs('deleteModal');
      const successModal = qs('successModal');
      
      if (addModal && e.target === addModal) {
        closeAddProjectModal();
      } else if (deleteModal && e.target === deleteModal) {
        cancelDelete();
      } else if (successModal && e.target === successModal) {
        closeSuccessModal();
      }
    });

    // Close modals on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const draftModal = qs('draftModal');
        const deleteModal = qs('deleteModal');
        const successModal = qs('successModal');
        
        if (draftModal && draftModal.classList.contains('show')) {
          discardDraft();
        } else if (deleteModal && deleteModal.classList.contains('show')) {
          cancelDelete();
        } else if (successModal && successModal.classList.contains('show')) {
          closeSuccessModal();
        }
      }
    });

    async function saveProject() {
      const projectData = {
        code: qs('projectCode').value.trim(),
        startDate: qs('startDate').value.trim(),
        client: qs('clientName').value.trim(),
        name: qs('projectName').value.trim(),
        industry: qs('industry').value.trim(),
        location: qs('location').value.trim(),
        pic: qs('pic').value.trim()
      };

      // Validate required fields
      if (!projectData.code || !projectData.startDate || !projectData.client || !projectData.name || !projectData.industry || !projectData.location || !projectData.pic) {
        alert('Please fill in all fields');
        return;
      }

      try {
        const headers = Object.assign(
          { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {})
        );

        if (isEditMode) {
          // Edit existing project via PUT
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs/' + encodeURIComponent(editingProjectCode);
          const res = await fetch(url, {
            method: 'PUT',
            headers: headers,
            body: JSON.stringify(projectData)
          });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          console.log('Project updated:', projectData);
          
          // Clear edit draft after successful update
          clearEditDraft(editingProjectCode);
          
          // Close modal first
          closeAddProjectModal();
          
          // Show success message
          showSuccessModal('Project Updated Successfully!', `"${projectData.name}" has been updated.`);
          
          // Reload the projects list from backend
          await loadProjects();
        } else {
          // Add new project via POST
          const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/projectdefs';
          const res = await fetch(url, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(projectData)
          });
          const data = await res.json();
          
          if (!res.ok || !data.ok) {
            throw new Error(data.error || ('HTTP ' + res.status));
          }
          
          console.log('Project added:', projectData);
          
          // Clear draft after successful save
          clearDraft();
          
          // Close modal first
          closeAddProjectModal();
          
          // Show success message
          showSuccessModal('Project Added Successfully!', `"${projectData.name}" has been added to the project list.`);
          
          // Reload the projects list from backend
          await loadProjects();
        }
      } catch (e) {
        alert('Failed to save project: ' + (e && e.message ? e.message : String(e)));
      }
    }

    function showSuccessModal(title, message) {
      qs('successTitle').textContent = title;
      qs('successMessage').textContent = message;
      qs('successModal').classList.add('show');
      
      // Auto-close after 3 seconds
      setTimeout(() => {
        closeSuccessModal();
      }, 3000);
    }

    function closeSuccessModal() {
      qs('successModal').classList.remove('show');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      if (!(await ensureAdmin())) return;
      qs('backBtn').addEventListener('click', () => { window.location.replace('admin.html'); });
      
      // Add Project button click handler
      setTimeout(() => {
        const addBtn = qs('addProjectBtn');
        if (addBtn) {
          addBtn.addEventListener('click', openAddProjectModal);
        }
      }, 100);
      
      try { await loadProjects(); } catch (e) { alert('Failed to load projects: ' + (e && e.message ? e.message : String(e))); }
    });
  </script>
</head>
<body>
  <div class="brand-header">
    <h1>Project List</h1>
    <button id="backBtn" class="secondary" style="background:#e2e8f0;color:#0f172a;cursor:pointer;">Back</button>
  </div>
  <div class="container">
    <div id="list">
      <div class="muted">Loadingâ€¦</div>
    </div>
  </div>
  <!-- Success Modal -->
  <div id="successModal" class="success-modal-overlay" role="dialog" aria-modal="true">
    <div class="success-modal-content">
      <div class="success-icon">âœ“</div>
      <h3 id="successTitle" class="success-title">Success!</h3>
      <p id="successMessage" class="success-message">Operation completed successfully.</p>
      <button type="button" class="success-btn" onclick="closeSuccessModal()">OK</button>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="delete-modal-overlay" role="dialog" aria-modal="true">
    <div class="delete-modal-dialog">
      <p class="delete-modal-title">Delete Project?</p>
      <p id="deleteModalText" class="delete-modal-text">Are you sure you want to delete this project?</p>
      <div class="delete-modal-actions">
        <button type="button" class="delete-confirm-btn" onclick="confirmDelete()">YES</button>
        <button type="button" class="delete-cancel-btn" onclick="cancelDelete()">NO</button>
      </div>
    </div>
  </div>

  <!-- Draft Notification Modal -->
  <div id="draftModal" class="draft-modal-overlay" role="dialog" aria-modal="true">
    <div class="draft-modal-content">
      <div class="draft-modal-icon">ðŸ“</div>
      <h3 class="draft-modal-title">Unsaved Draft Found</h3>
      <p class="draft-modal-message">You have an unfinished project form. Would you like to continue editing it or start fresh?</p>
      <div class="draft-modal-actions">
        <button type="button" class="draft-btn-primary" onclick="useDraftData()">Continue Editing</button>
        <button type="button" class="draft-btn-secondary" onclick="discardDraft()">Start Fresh</button>
      </div>
    </div>
  </div>

  <!-- Add Project Modal -->
  <div id="addProjectModal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <h2 id="modalTitle">PROJECT DETAILS</h2>
      </div>
      <div class="modal-body">
        <form id="projectForm" onsubmit="event.preventDefault(); saveProject();">
          <div class="form-group">
            <label for="projectCode">Project Code:</label>
            <input type="text" id="projectCode" required>
          </div>
          <div class="form-group">
            <label for="startDate">PO/ Start Date:</label>
            <input type="text" id="startDate" placeholder="MM/DD/YYYY" required>
          </div>
          <div class="form-group">
            <label for="clientName">Client Name:</label>
            <input type="text" id="clientName" required>
          </div>
          <div class="form-group">
            <label for="projectName">Project Name:</label>
            <input type="text" id="projectName" required>
          </div>
          <div class="form-group">
            <label for="industry">Industry:</label>
            <input type="text" id="industry" required>
          </div>
          <div class="form-group">
            <label for="location">Location:</label>
            <input type="text" id="location" required>
          </div>
          <div class="form-group">
            <label for="pic">PIC:</label>
            <input type="text" id="pic" required>
          </div>
          <div class="modal-actions">
            <button type="submit" class="save-btn">SAVE</button>
            <button type="button" class="cancel-btn" onclick="closeAddProjectModal()">CANCEL</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js').catch(() => {}); }
  </script>
</body>
</html>



