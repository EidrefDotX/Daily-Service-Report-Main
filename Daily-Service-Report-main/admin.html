<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - Daily Service Reports</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#2563eb">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background: #f6f7fb; color: #0f172a; }
    .brand-header { background: #000; color: #fff; padding: 20px 24px; text-align: left; margin: 0; }
    .brand-header h1 { margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px; }
    .container { max-width: 1100px; margin: 24px auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    h1 { margin: 0 0 16px; font-size: 22px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .filters { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; margin: 12px 0 16px; }
    input, select, button { padding: 8px 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px; }
    button { appearance: none; border: 0; background: #2563eb; color: #fff; font-weight: 600; cursor: pointer; }
    button.secondary { background: #e2e8f0; color: #0f172a; }
    table { width: 100%; border-collapse: collapse; }
    th, td { font-size: 13px; padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
    th { background: #f8fafc; }
    .muted { color: #64748b; }
    .logout-btn { background: #ef4444; color: #fff; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 0; font-weight: 600; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .modal-overlay.show { display: flex; }
    .modal-dialog { background: #fff; width: 95%; max-width: 720px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .modal-body { max-height: 70vh; overflow: auto; }
    .sig { max-width: 100%; height: auto; border: 1px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; }
  </style>
  <script src="auth.js"></script>
  <script>
    function qs(id){ return document.getElementById(id); }

    async function ensureAdmin() {
      try {
        if (!window.DSRAuth || !DSRAuth.isLoggedIn()) {
          window.location.replace('login.html?redirect=' + encodeURIComponent('admin.html'));
          return false;
        }
        const me = await DSRAuth.me();
        if (!me.ok || !me.authenticated || !me.user || me.user.role !== 'admin') {
          alert('Admin access required');
          window.location.replace('login.html?redirect=' + encodeURIComponent('admin.html'));
          return false;
        }
        return true;
      } catch (_) {
        window.location.replace('login.html?redirect=' + encodeURIComponent('admin.html'));
        return false;
      }
    }

    function buildQuery(params) {
      const sp = new URLSearchParams();
      Object.entries(params).forEach(([k,v]) => { if (v) sp.set(k, v); });
      const s = sp.toString();
      return s ? ('?' + s) : '';
    }

    async function fetchReports() {
      const engineer = qs('fEngineer').value.trim();
      const project = qs('fProject').value.trim();
      const df = qs('fFrom').value.trim();
      const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
      const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/reports' + buildQuery({
        engineer, project_code: project, date_from: df
      });
      const res = await fetch(url, { headers });
      const isJson = (res.headers.get('content-type') || '').includes('application/json');
      const data = isJson ? await res.json() : { ok: false };
      if (!res.ok || !data.ok) {
        throw new Error(data.error || ('HTTP ' + res.status));
      }
      return data.items || [];
    }

    function renderRows(items) {
      const tbody = qs('rows');
      tbody.innerHTML = '';
      if (!items.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No reports found</td></tr>';
        return;
      }
      for (const r of items) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${r.reportDate || ''}</td>
          <td>${r.engineerName || ''}</td>
          <td>${r.projectCode || ''}</td>
          <td>${r.projectName || ''}</td>
          <td>${r.onSiteTimeIn || ''} - ${r.onSiteTimeOut || ''}</td>
          <td>${r.travelTimeToSite || ''} - ${r.travelTimeFromSite || ''}</td>
          <td><button data-id="${r.id}" class="secondary">View</button></td>
        `;
        tbody.appendChild(tr);
      }
      tbody.querySelectorAll('button[data-id]').forEach(btn => {
        btn.addEventListener('click', () => openDetail(btn.getAttribute('data-id')));
      });
    }

    async function openDetail(id) {
      const headers = Object.assign({ 'Accept': 'application/json' }, (DSRAuth.getAuthHeader ? DSRAuth.getAuthHeader() : {}));
      const url = (DSRAuth.getApiBase ? DSRAuth.getApiBase() : '') + '/reports/' + id;
      const res = await fetch(url, { headers });
      const isJson = (res.headers.get('content-type') || '').includes('application/json');
      const data = isJson ? await res.json() : { ok: false };
      if (!res.ok || !data.ok) {
        alert(data.error || ('HTTP ' + res.status));
        return;
      }
      const r = data.item;
      qs('mTitle').textContent = `Report #${r.id} — ${r.engineerName} (${r.reportDate})`;
      qs('mBody').innerHTML = `
        <p><strong>Project:</strong> ${r.projectCode} — ${r.projectName}</p>
        <p><strong>On-site:</strong> ${r.onSiteTimeIn} - ${r.onSiteTimeOut}</p>
        <p><strong>Travel to site:</strong> ${r.travelTimeToSite} - ${r.travelTimeFromSite}</p>
        <p><strong>Work objective:</strong><br>${escapeHtml(r.workObjective || '')}</p>
        <p><strong>Description:</strong><br>${escapeHtml(r.description || '')}</p>
        <p><strong>Outcome:</strong><br>${escapeHtml(r.outcome || '')}</p>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
          <div>
          </div>
        </div>
      `;
      qs('modal').classList.add('show');
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]); });
    }

    function closeModal() {
      qs('modal').classList.remove('show');
    }

    async function doLogout(event, btn) {
      try { if (event && typeof event.preventDefault === 'function') event.preventDefault(); } catch (_) {}
      try { if (btn) { btn.disabled = true; btn.textContent = 'Logging out...'; } } catch (_) {}
      try {
        // Best-effort server logout
        if (window.DSRAuth && typeof DSRAuth.logout === 'function') await DSRAuth.logout();
      } catch (_) {}
      try { localStorage.removeItem('dsr_session'); } catch (_) {}
      try { localStorage.removeItem('dsr_jwt_token'); } catch (_) {}
      try { sessionStorage.removeItem('dsr_redirect_to'); } catch (_) {}
      try { window.location.replace('login.html'); } catch (_) { window.location.href = 'login.html'; }
    }

    async function applyFilters(event) {
      if (event) event.preventDefault();
      qs('loadBtn').disabled = true;
      qs('loadBtn').textContent = 'Loading...';
      try {
        const items = await fetchReports();
        renderRows(items);
      } catch (e) {
        alert('Error loading reports: ' + (e && e.message ? e.message : String(e)));
      } finally {
        qs('loadBtn').disabled = false;
        qs('loadBtn').textContent = 'Load';
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      if (!(await ensureAdmin())) return;
      document.querySelectorAll('.filters input').forEach(el => el.addEventListener('change', applyFilters));
      qs('loadBtn').addEventListener('click', applyFilters);
      qs('closeModal').addEventListener('click', closeModal);
      await applyFilters();
    });
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(() => {});
    }
  </script>
  <style>
    @media (max-width: 800px) {
      .filters { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="brand-header">
    <h1>dot[X]solutions</h1>
  </div>
  <div class="container">
    <div class="topbar">
      <h1>Admin — Daily Service Reports</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="logout-btn" onclick="doLogout(event, this)">Logout</button>
      </div>
    </div>

    <div class="filters">
      <input id="fEngineer" type="text" placeholder="Engineer name">
      <input id="fProject" type="text" placeholder="Project code">
      <input id="fFrom" type="date" placeholder="From date">
    </div>
    <div style="margin-bottom:12px">
      <button id="loadBtn">Load</button>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Engineer</th>
            <th>Project Code</th>
            <th>Project Name</th>
            <th>On-site</th>
            <th>Travel</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="8" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="modal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-dialog">
      <div class="modal-header">
        <div id="mTitle" style="font-weight:700">Report</div>
        <button id="closeModal" class="secondary">Close</button>
      </div>
      <div id="mBody" class="modal-body"></div>
    </div>
  </div>
</body>
</html>


